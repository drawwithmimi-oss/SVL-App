<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#904dff" />
  <title>Voice Training Companion - Transfem Edition</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="../manifest.json" />

  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="../assets/Visuals/icones/Logo/logosquare.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Voice Trainer" />

  <!-- React / Babel / Tailwind -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- WebAudioRecorder.js Library -->
  <script src="../js/WebAudioRecorder.min.js"></script>

  <!-- Averia Serif Libre Font -->
  <link href="https://fonts.googleapis.com/css2?family=Averia+Serif+Libre:wght@700&display=swap" rel="stylesheet">

  <style>
    /* Custom CSS Variables for Brand Colors */
    :root {
      --brand-purple: #904dff;
      --brand-orange: #ff722f;
      --brand-pink: #ffa2fe;
      --brand-yellow: #fdd55a;
      --brand-beige: #fff4f2;
      --brand-grey: #3b1e36;
      --brand-blue: #6f81ff;
    }

    /* Dyslexia-friendly spacing; keep the simple, readable sans font you chose */
    .reading-text {
      font-family: Arial, Helvetica, sans-serif;
      line-height: 2;
      letter-spacing: 0.05em;
      word-spacing: 0.2em;
    }

    html { scroll-behavior: smooth; }

    /* Touch targets */
    button { min-height: 44px; min-width: 44px; }

    /* Cards with rounded corners */
    .training-card {
      transition: all 0.3s ease;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(59, 30, 54, 0.1);
    }

    .training-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(59, 30, 54, 0.15);
    }

    /* Floating bubble */
    .floating-bubble {
      position: fixed;
      right: 20px;
      bottom: 80px;
      z-index: 1000;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    .pitch-indicator { transition: all 0.3s ease; }

    /* Prevent accidental selection */
    button {
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Typography */
    .brand-heading {
      font-weight: 700;
      color: var(--brand-grey);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* iOS safe areas */
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    function VoiceTrainingReader() {
      const [isDronePlaying, setIsDronePlaying] = useState(false);
      const [selectedNote, setSelectedNote] = useState('C4');
      const [currentPitch, setCurrentPitch] = useState(0);
      const [micPermission, setMicPermission] = useState('pending');
      const [audioInitialized, setAudioInitialized] = useState(false);
      const [micActive, setMicActive] = useState(false);
      const [showBubble, setShowBubble] = useState(true); // Auto-show monitor
      const [bubbleExpanded, setBubbleExpanded] = useState(false);
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [selectedReading, setSelectedReading] = useState(null);
      const [fontSize, setFontSize] = useState('large');

      // Recording state
      const [isRecording, setIsRecording] = useState(false);
      const [recordings, setRecordings] = useState([]);
      const [lastRecording, setLastRecording] = useState(null);
      const [showRecordingsModal, setShowRecordingsModal] = useState(false);
      const webAudioRecorderRef = useRef(null);
      const recordingAudioContextRef = useRef(null);
      const audioRefs = useRef({});

      /* Check URL params on load to auto-select exercises */
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('section') === 'exercises') {
          const exercisesReading = readings.find(r => r.id === 'exercises-link');
          if (exercisesReading) {
            setSelectedReading(exercisesReading);
          }
        }
      }, []);

      /* Volume 0‚Äì200% of safe base gain (0.2) */
      const [volumePct, setVolumePct] = useState(100);
      const baseGain = 0.2;

      /* NEW: timbre + gentle loudness helpers */
      const [timbre, setTimbre] = useState('sine');      // sine, triangle, sawtooth, square
      const [softenHighs, setSoftenHighs] = useState(true); // lowpass to avoid "metallic"
      const [phoneBoost, setPhoneBoost] = useState(false);  // EQ + compressor for phones

      const audioContextRef = useRef(null);
      const oscillatorRef   = useRef(null);
      const gainNodeRef     = useRef(null);
      const analyserRef     = useRef(null);
      const micStreamRef    = useRef(null);
      const pitchDetectionRef = useRef(null);

      /* NEW: processing nodes so we can tweak live */
      const lowpassRef   = useRef(null);  // soften highs
      const highshelfRef = useRef(null);  // gentle clarity bump when boost on
      const compressorRef= useRef(null);  // loudness control for phones

      const notes = {
        'A3': 220.00, 'B3': 246.94, 'C4': 261.63, 'C#4': 277.18, 'D4': 293.66,
        'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00
      };

      /* Transfem Voice Training Readings */
      const readings = [
        {
          id: 'rainbow',
          title: 'Rainbow Passage',
          description: 'Classic voice training text',
          image: '../assets/Visuals/icones/Transfemme/Prism - rainbow passage.png',
          content: `When the sunlight strikes raindrops in the air, they act as a prism and form a rainbow. The rainbow is a division of white light into many beautiful colors. These take the shape of a long round arch, with its path high above, and its two ends apparently beyond the horizon. There is, according to legend, a boiling pot of gold at one end. People look, but no one ever finds it. When a person looks for something beyond their reach, their friends say they are looking for the pot of gold at the end of the rainbow.

Throughout the centuries people have explained the rainbow in various ways. Some have accepted it as a miracle without physical explanation. Others have tried to explain the phenomenon physically. Aristotle thought that the rainbow was caused by reflection of the sun's rays by the rain. Since then physicists have found that it is not reflection, but refraction by the raindrops which causes the rainbows.

Many complicated ideas about the rainbow have been formed. The difference in the rainbow depends considerably upon the size of the drops, and the width of the colored band increases as the size of the drops increases. The actual primary rainbow observed is said to be the effect of superimposition of a number of bows. If the red of the second bow falls upon the green of the first, the result is a bow with an abnormally wide yellow band, since red and green light when mixed form yellow. This is a very common type of bow, one showing mainly red and yellow, with little or no green or blue.`
        },
        {
          id: 'bouncy-lady-mary',
          title: 'Lady Mary from \'The Admirable Crichton\'',
          description: 'Bouncy Voice',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `I sighted a herd near Penguin's Creek, but had to creep round Silver Lake to get to windward of them. However, they spotted me and then the fun began. There was nothing for it but to try and run them down, so I singled out a fat buck and away we went down the shore of the lake, up the valley of rolling stones; he doubled into Brawling River and took to the water, but I swam after him; the river is only half a mile broad there, but it runs strong. He went spinning down the rapids, down I went in pursuit; he clambered ashore, I clambered ashore; away we tore helter-skelter up the hill and down again. I lost him in the marshes, got on his track again near Bread Fruit Wood, and brought him down with an arrow in Firefly Grove.`
        },
        {
          id: 'bouncy-lucy',
          title: 'Lucy Van Pelt from \'You\'re A Good Man, Charlie Brown\'',
          description: 'Bouncy Voice',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `Do you know what I intend? I intend to be a queen. When I grow up I'm going to be the biggest queen there ever was, and I'll live in a big palace and when I go out in my coach, all the people will wave and I will shout at them, and...and...in the summertime I will go to my summer palace and I'll wear my crown in swimming and everything, and all the people will cheer and I will shout at them... What do you mean I can't be queen? Nobody should be kept from being a queen if she wants to be one. It's usually just a matter of knowing the right people....well.... if I can't be a queen, then I'll be very rich then I will buy myself a queendom. Yes, I will buy myself a queendom and then I'll kick out the old queen and take over the whole operation myself. I will be head queen.`
        },
        {
          id: 'tempo-sally',
          title: 'Sally Brown from \'You\'re A Good Man, Charlie Brown\'',
          description: 'Tempo Variance',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `A 'C'? A 'C'? I got a 'C' on my coathanger sculpture? How could anyone get a 'C' in coathanger sculpture? May I ask a question? Was I judged on the piece of sculpture itself? If so, is it not true that time alone can judge a work of art? Or was I judged on my talent? If so, is it fair that I be judged on a part of my life over which I have no control? If I was judged on my effort, then I was judged unfairly, for I tried as hard as I could! Was I judged on what I had learned about this project? If so, then were not you, my teacher, also being judged on your ability to transmit your knowledge to me? Are you willing to share my 'C'? Perhaps I was being judged on the quality of coathanger itself out of which my creation was made...now is this not also unfair? Am I to be judged by the quality of coat hangers that are used by the drycleaning establishment that returns our garments? Is that not the responsibility of my parents? Should they not share my 'C'?`
        },
        {
          id: 'tempo-beatrix',
          title: 'Beatrix from \'Promedy\'',
          description: 'Tempo Variance',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `Young women need the Prom. It's a rite of passage as sacred as getting your driver's license or buying your first bra. There are only a few things in life that are guaranteed to be glorious and memorable and sparkling with gowns and cumberbunds. Prom is the quintessential teenage experience. Think of the unlucky grown-ups and the elderly who lament the day they decided not to go to the Prom. It is a key ingredient to a happy and meaningful life. Prom is short for Promenade, a slow, gentle walk through a shady glen, and this beloved ceremony symbolizes our journey from the shadows of adolescence to the bright sunshine of the adult world with all its freedoms. And it may be the only chance I'll ever have to dance with someone. Maybe I'll never have someone get down on a knee and offer me a diamond ring. Maybe I'll never walk down the aisle with a smug look of bridal triumph. But it is my right, and the right of every book-wormy, soon-to-be librarian to have one night of Cinderella magic. Even if we have to go with our cousin, or our gay best friend from tap class, we will have a Prom. And you will help me.`
        },
        {
          id: 'vowel-sister-winnie',
          title: 'Sister Winnie from \'Folk\'',
          description: 'Vowel Elongation',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `Oh, it was fine. I mean: not fine fine ‚Äì everything's... I've been at the hospital, Kayleigh. I don't know if Stephen said. Getting some tests done. I've got angina. Which for some reason I keep calling: vagina. It doesn't help. It means, Kayleigh, no more fun. No more drinking, no more getting worked up, no more smoking, apparently ‚Äì I'm ignoring that, obviously but. I'm getting pills, blood-thinners. They've showered me with leaflets. The consultant basically said I could pop my clogs at any moment. Added to which: he was a very pale man, heavy-breather ‚Äì I did wonder briefly if he might actually be Death, come to get me. But then one of the other doctors popped in, called him Nigel, mentioned something about badminton so I thought: probably not. It's hard to imagine the Grim Reaper with a shuttlecock. But that's not the worst bit, Stephen. Picture this: I've been through all the sitting, the waiting, been wired up to a monitor, jogged, et cetera, I've been jiggled about, prodded, pressed with some very chilly instruments, got released, finally, back into the world, with my clogged-up arteries and uncertain future, I'm in the lift going down, who should get into the lift with me on floor number seven? I'll give you a clue: he's got a hernia. And did he ask how I was? No. He spotted me, took a deep breath, launched into another two-hour rant about what a rough deal it is ‚Äì complaining, whining. I mean, I know it's not nice to have a bit of your stomach lining poking out, I get it, I do, but really ‚Äì how much more is there to say?`
        },
        {
          id: 'vowel-sophia',
          title: 'Sophia from \'Girlboss\'',
          description: 'Vowel Elongation',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `Adulthood is where dreams go to die. Grow up, get a job, become a drone, that's it. Then it's over. Society just wants to put everyone in a box. Well guess what society? There is no box. Cos I mean, if I thought the rest of my life would be spent as a mindless cog in a machine, I swear I'd just get a tattoo across my face that says: "Really man?" Just need to figure out a way of growing up without becoming a boring adult. You probably think I'm some spoiled brat who's never had it hard cause I didn't have to walk a mile to school. But here's the thing, I tried college for a year. Total bust. Everything you wanna learn, you could just look up online. I know how to open champagne with a sword.`
        },
        {
          id: 'diction-elaine',
          title: 'Elaine from \'The Graduate\'',
          description: 'Diction and Articulation',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `Well nothing's perfect Benjamin. I wish my mother didn't drink so much. I wish I'd never fallen out of that tree and broken my thumb because it so affects my fingering I'll probably never play the violin as well as I'd love to but that's about it for the bullshit, Benjamin. It's only bullshit if you let it pile up. Heaven's in the details. Someone said that. I think Robert Frost said that. I was in this diner with my roommate Diane? And this guy came along with a goat on a rope and it turns out the reason he's got a little goat on a rope is that he was thrown out the day before for bringing in his dog? But the point is that Diane had stood up to leave when she saw the man walk in and she sat straight down again and said, well if there's a goat I think I'll have dessert. And that's why I love Diane, because if you think like that you not only notice more little goats, you get more dessert.`
        },
        {
          id: 'diction-gwendolen',
          title: 'Gwendolen Fairfax from \'The Importance of Being Earnest\'',
          description: 'Diction and Articulation',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `Oh! It is strange he never mentioned to me that he had a ward. How secretive of him! He grows more interesting hourly. I am not sure, however, that the news inspires me with feelings of unmixed delight. I am very fond of you, Cecily; I have liked you ever since I met you! But I am bound to state that now that I know that you are Mr. Worthing's ward, I cannot help expressing a wish you were‚Äîwell, just a little older than you seem to be‚Äîand not quite so very alluring in appearance. In fact, if I may speak candidly‚Äî [...] Well, to speak with perfect candour, Cecily, I wish that you were fully forty-two, and more than usually plain for your age. Ernest has a strong upright nature. He is the very soul of truth and honour. Disloyalty would be as impossible to him as deception. But even men of the noblest possible moral character are extremely susceptible to the influence of the physical charms of others. Modern, no less than Ancient History, supplies us with many most painful examples of what I refer to. If it were not so, indeed, History would be quite unreadable.`
        },
        {
          id: 'syllable-dont-look',
          title: '\'Don\'t Look At Me\' - monologue by Joseph Arnone',
          description: 'Syllable Separation',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `Don't look at me. You. Eh, eh, eh...when I address you, do not look at me. No eye contact. Is that understood? Look away. (beat) Okay, look at me now. (snaps her fingers) I told you not to look at me. Even if I tell you to look at me, do not look at me. Understood? Good, good darling.

Oh! I have something in my eye, can you help me? (pointing) Looking, looking, looking! NO looking under all circumstances. You must raise up that attention span of yours. A fish could retain more darling. That is true. I have read it. Less attention span than a fish. Do not let that be you darling.`
        },
        {
          id: 'syllable-eliza',
          title: 'Eliza Doolittle from \'My Fair Lady\'',
          description: 'Syllable Separation',
          image: '../assets/Visuals/icones/Transfemme/Fem monologues .png',
          content: `My aunt died of influenza, so they said. But it's my belief they done the old woman in. Yes Lord love you! Why should she die of influenza when she come through diphtheria right enough the year before? Fairly blue with it she was. They all thought she was dead. But my father, he kept ladling gin down her throat. Then she come to so sudden that she bit the bowl off the spoon. Now, what would you call a woman with that strength in her have to die of influenza, and what become of her new straw hat that should have come to me? Somebody pinched it, and what I say is, them that pinched it, done her in. Them she lived with would have killed her for a hat-pin, let alone a hat. And as for father ladling the gin down her throat, it wouldn't have killed her. Not her. Gin was as mother's milk to her. Besides, he's poured so much down his own throat that he knew the good of it.`
        },
        {
          id: 'exercises-link',
          title: 'üìã Exercise Resources',
          description: 'Additional practice materials and guides',
          content: 'RESOURCES',
          isResourceList: true,
          resources: [
            { title: 'Consonant Buddies', pdfUrl: 'https://drive.google.com/file/d/1b2hiNqxY859vPY2yd57YiZ3jJ3EiJuIY/view?usp=share_link', digitalPage: './exercises/consonant-buddies.html', status: 'available' },
            { title: 'Vowel Placement', pdfUrl: 'https://drive.google.com/file/d/1fZMboAFWvQdTeY69iynK3cIpABiI9t-u/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Fem Monologue', pdfUrl: 'https://drive.google.com/file/d/1V_qQbCDZSX5p9Ltl_QGdNruE_vZRQfwh/view?usp=drive_link', digitalPage: './index.html', status: 'available' },
            { title: 'Fem Vowels - Diphthongs', pdfUrl: 'https://drive.google.com/file/d/1RTfmdl9flI8sAft2lnJF0K2nAzaKLhX0/view?usp=drive_link', digitalPage: './exercises/fem-vowels-diphthongs.html', status: 'available' },
            { title: 'Fem Vowels - Pure', pdfUrl: 'https://drive.google.com/file/d/13D7saIPU8mtlIgQwy1e-UNkbQZo5PXZS/view?usp=sharing', digitalPage: './exercises/fem-vowels-pure.html', status: 'available' },
            { title: 'Tongue Exercises For Students', digitalPage: './exercises/tongue-exercises.html', status: 'available', isVideo: true },
            { title: 'MTF Students Syllabus', pdfUrl: 'https://drive.google.com/file/d/1fcfuEcKcqvJg-UxA2Lc1hfmjEZ_DuOXj/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Rainbow Passage', pdfUrl: 'https://drive.google.com/file/d/1Tw-oO8pFV1NJQLQxrlx9u4BPb7Am2aiN/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Rainbow Passage with Breaths', pdfUrl: 'https://drive.google.com/file/d/1Ihr6Es--WdxQpuQwvAtc2D_Ps9YV8O9-/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Recovery Bingo', pdfUrl: 'https://drive.google.com/file/d/1vw6i6ybc4K4nKFwbku3k_mj19vi3kl_t/view?usp=drive_link', digitalPage: './exercises/recovery-bingo.html', status: 'available' },
            { title: 'Snowflake Concept Map', pdfUrl: 'https://drive.google.com/file/d/1JeuLGR5CzxuLJSe3_NYfhfq-wLlaPF6z/view?usp=drive_link', status: 'coming-soon' }
          ]
        }
      ];

      /* Init mic + analyser */
      const initAudio = useCallback(async () => {
        try {
          // Create AudioContext first (iOS requires this before getUserMedia)
          if (!audioContextRef.current) {
            audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
          }

          // iOS/Safari: AudioContext starts suspended, must resume with user gesture
          if (audioContextRef.current.state === 'suspended') {
            await audioContextRef.current.resume();
          }

          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: false,
              noiseSuppression: false,
              autoGainControl: false
            }
          });
          micStreamRef.current = stream;
          setMicPermission('granted');

          const source = audioContextRef.current.createMediaStreamSource(stream);
          analyserRef.current = audioContextRef.current.createAnalyser();
          analyserRef.current.fftSize = 2048;
          source.connect(analyserRef.current);

          setAudioInitialized(true);
          startPitchDetection();
        } catch (err) {
          console.error('Microphone error:', err);
          if (err.name === 'NotAllowedError') {
            setMicPermission('denied');
          } else if (err.name === 'NotFoundError') {
            console.error('No microphone found');
            setMicPermission('denied');
          } else {
            setMicPermission('denied');
          }
        }
      }, []);

      /* Pitch detection (simple dominant-bin) */
      const startPitchDetection = useCallback(() => {
        if (!analyserRef.current || !audioContextRef.current) return;

        const bufferLength = analyserRef.current.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const detect = () => {
          if (!analyserRef.current) return;
          analyserRef.current.getByteFrequencyData(dataArray);

          let maxValue = 0, maxIndex = 0;
          for (let i = 0; i < bufferLength; i++) {
            if (dataArray[i] > maxValue) { maxValue = dataArray[i]; maxIndex = i; }
          }

          if (maxValue > 50) {
            const nyquist = audioContextRef.current.sampleRate / 2;
            const frequency = (maxIndex * nyquist) / bufferLength;
            if (frequency > 80 && frequency < 500) setCurrentPitch(Math.round(frequency));
          } else {
            setCurrentPitch(0);
          }

          pitchDetectionRef.current = requestAnimationFrame(detect);
        };

        detect();
      }, []);

      // Stop microphone completely during playback (exactly like demo)
      const stopMicrophoneForPlayback = useCallback(() => {
        console.log('Stopping microphone for playback');

        // Stop pitch detection
        if (pitchDetectionRef.current) {
          cancelAnimationFrame(pitchDetectionRef.current);
          pitchDetectionRef.current = null;
        }

        // Stop microphone stream completely (iOS volume fix - matches demo behavior)
        if (micStreamRef.current) {
          micStreamRef.current.getTracks().forEach(track => {
            console.log('Stopping track:', track.label);
            track.stop();
          });
          micStreamRef.current = null;
        }

        // NOTE: Demo does NOT suspend/close AudioContext - leaving it running is correct!
        // iOS interprets suspend() as "interrupted audio" which triggers low volume mode
      }, []);

      // Restart microphone after playback
      const restartMicrophoneAfterPlayback = useCallback(async () => {
        console.log('Restarting microphone after playback, micActive:', micActive);

        if (!micActive) return;

        try {
          // Re-initialize microphone (this will create new stream and restart pitch detection)
          await initAudio();
        } catch (error) {
          console.error('Error restarting microphone:', error);
        }
      }, [micActive, initAudio]);

      /* Start/Stop drone */
      const startDrone = useCallback(async () => {
        if (!audioContextRef.current) return;
        try {
          // iOS/Safari unlock on gesture
          if (audioContextRef.current.state === 'suspended') {
            await audioContextRef.current.resume();
          }

          const ctx = audioContextRef.current;
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          const lowpass = ctx.createBiquadFilter();
          const shelf   = ctx.createBiquadFilter();
          const comp    = ctx.createDynamicsCompressor();

          // Timbre + note
          osc.type = timbre;
          osc.frequency.value = notes[selectedNote];

          // Soften metallic edge with a gentle lowpass when enabled
          lowpass.type = 'lowpass';
          lowpass.frequency.value = softenHighs ? 2400 : 18000;
          lowpass.Q.value = 0.7;

          // Subtle clarity for small speakers when "phone boost" is on
          shelf.type = 'highshelf';
          shelf.frequency.value = 2500;
          shelf.gain.value = phoneBoost ? 3 : 0;

          // Dynamics to raise perceived loudness on phones
          if (phoneBoost) {
            comp.threshold.setValueAtTime(-26, ctx.currentTime);
            comp.knee.setValueAtTime(9, ctx.currentTime);
            comp.ratio.setValueAtTime(3, ctx.currentTime);
          } else {
            // Neutral settings (effectively bypass)
            comp.threshold.setValueAtTime(0, ctx.currentTime);
            comp.knee.setValueAtTime(0, ctx.currentTime);
            comp.ratio.setValueAtTime(1, ctx.currentTime);
          }
          comp.attack.setValueAtTime(0.003, ctx.currentTime);
          comp.release.setValueAtTime(0.25, ctx.currentTime);

          // Volume uses base gain scaled by slider (0‚Äì200%)
          gain.gain.value = baseGain * (volumePct / 100);

          // Connect graph: osc -> lowpass -> highshelf -> compressor -> gain -> out
          osc.connect(lowpass);
          lowpass.connect(shelf);
          shelf.connect(comp);
          comp.connect(gain);
          gain.connect(ctx.destination);

          osc.start();

          oscillatorRef.current = osc;
          gainNodeRef.current = gain;
          lowpassRef.current = lowpass;
          highshelfRef.current = shelf;
          compressorRef.current = comp;

          setIsDronePlaying(true);
        } catch (error) {
          console.error('Drone error:', error);
        }
      }, [selectedNote, timbre, softenHighs, phoneBoost, volumePct]);

      const stopDrone = useCallback(() => {
        if (oscillatorRef.current) {
          try { oscillatorRef.current.stop(); } catch {}
          oscillatorRef.current = null;
        }
        gainNodeRef.current = null;
        lowpassRef.current = null;
        highshelfRef.current = null;
        compressorRef.current = null;
        setIsDronePlaying(false);
      }, []);

      const activateMicrophone = useCallback(async () => {
        if (!audioInitialized) {
          await initAudio();
        }
        // Ensure AudioContext is running (iOS requirement)
        if (audioContextRef.current && audioContextRef.current.state === 'suspended') {
          await audioContextRef.current.resume();
        }
        setMicActive(true);
      }, [audioInitialized, initAudio]);

      const togglePitchMonitor = useCallback(async () => {
        if (audioContextRef.current && audioContextRef.current.state === 'suspended') {
          try { await audioContextRef.current.resume(); } catch {}
        }
        setShowBubble(true);
      }, []);

      const adjustNote = useCallback((direction) => {
        const noteArray = Object.keys(notes);
        const currentIndex = noteArray.indexOf(selectedNote);
        let newIndex = direction === 'up' ? currentIndex + 1 : currentIndex - 1;
        newIndex = Math.max(0, Math.min(noteArray.length - 1, newIndex));
        const newNote = noteArray[newIndex];
        setSelectedNote(newNote);

        if (oscillatorRef.current) {
          oscillatorRef.current.frequency.value = notes[newNote];
        }
      }, [selectedNote]);

      // Recording functions using WebAudioRecorder
      const startRecording = useCallback(async () => {
        if (!micStreamRef.current) {
          console.error('No microphone stream available');
          return;
        }

        try {
          // Create new AudioContext for recording (after getUserMedia, iOS requirement)
          recordingAudioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();

          const input = recordingAudioContextRef.current.createMediaStreamSource(micStreamRef.current);

          // Create WebAudioRecorder with WAV format (universal compatibility)
          const recorder = new WebAudioRecorder(input, {
            workerDir: "../js/",
            encoding: 'wav',
            numChannels: 2, // Stereo like demo
            onEncoderLoading: function(recorder, encoding) {
              console.log("Loading " + encoding + " encoder...");
            },
            onEncoderLoaded: function(recorder, encoding) {
              console.log(encoding + " encoder loaded");
            }
          });

          recorder.onComplete = function(recorder, blob) {
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toLocaleString();
            const newRecording = {
              id: Date.now(),
              timestamp,
              blob,
              url,
              duration: null,
              mimeType: 'audio/wav',
              encoding: 'wav'
            };

            setRecordings(prev => [...prev, newRecording]);
            setLastRecording(newRecording);
            console.log("WAV encoding complete");
          };

          recorder.setOptions({
            timeLimit: 300, // 5 minutes max
            encodeAfterRecord: true
          });

          webAudioRecorderRef.current = recorder;
          recorder.startRecording();
          setIsRecording(true);
        } catch (error) {
          console.error('Error starting recording:', error);
          alert('Recording failed. Please ensure microphone access is granted and try again.');
        }
      }, []);

      const stopRecording = useCallback(() => {
        if (webAudioRecorderRef.current && isRecording) {
          webAudioRecorderRef.current.finishRecording();
          setIsRecording(false);

          // Clean up recording audio context
          if (recordingAudioContextRef.current) {
            try {
              recordingAudioContextRef.current.close();
            } catch (e) {}
            recordingAudioContextRef.current = null;
          }
        }
      }, [isRecording]);

      const deleteRecording = useCallback((id) => {
        setRecordings(prev => {
          const recording = prev.find(r => r.id === id);
          if (recording) {
            URL.revokeObjectURL(recording.url);
          }
          return prev.filter(r => r.id !== id);
        });
        if (lastRecording && lastRecording.id === id) {
          setLastRecording(null);
        }
      }, [lastRecording]);

      const downloadRecording = useCallback((recording) => {
        const a = document.createElement('a');
        a.href = recording.url;
        const ext = recording.encoding || 'wav';
        a.download = `voice-recording-${recording.id}.${ext}`;
        a.click();
      }, []);

      /* Keep mic + context lifecycle clean */
      useEffect(() => {
        initAudio();
        // Default: enable boost on small screens
        try {
          if (window.matchMedia && window.matchMedia('(max-width: 480px)').matches) {
            setPhoneBoost(true);
          }
        } catch {}
        return () => {
          if (pitchDetectionRef.current) cancelAnimationFrame(pitchDetectionRef.current);
          if (oscillatorRef.current) { try { oscillatorRef.current.stop(); } catch {} }
          if (micStreamRef.current) micStreamRef.current.getTracks().forEach(t => t.stop());
          if (audioContextRef.current) { try { audioContextRef.current.close(); } catch {} }
        };
      }, [initAudio]);

      /* Stop mic when recordings modal opens (for loud playback on iOS) */
      useEffect(() => {
        if (showRecordingsModal) {
          console.log('Recordings modal opened - stopping microphone');
          stopMicrophoneForPlayback();
        } else if (micActive && !micStreamRef.current) {
          console.log('Recordings modal closed - restarting microphone');
          restartMicrophoneAfterPlayback();
        }
      }, [showRecordingsModal, micActive]);

      /* Live updates while playing */
      useEffect(() => {
        if (gainNodeRef.current) {
          gainNodeRef.current.gain.value = baseGain * (volumePct / 100);
        }
      }, [volumePct]);

      useEffect(() => {
        if (oscillatorRef.current) oscillatorRef.current.type = timbre;
      }, [timbre]);

      useEffect(() => {
        if (oscillatorRef.current) {
          oscillatorRef.current.frequency.value = notes[selectedNote];
        }
      }, [selectedNote]);

      useEffect(() => {
        if (lowpassRef.current) {
          lowpassRef.current.frequency.value = softenHighs ? 2400 : 18000;
        }
      }, [softenHighs]);

      useEffect(() => {
        const ctx = audioContextRef.current;
        if (ctx && compressorRef.current && highshelfRef.current) {
          const comp = compressorRef.current;
          const shelf = highshelfRef.current;
          if (phoneBoost) {
            comp.threshold.setValueAtTime(-26, ctx.currentTime);
            comp.knee.setValueAtTime(9, ctx.currentTime);
            comp.ratio.setValueAtTime(3, ctx.currentTime);
            shelf.gain.value = 3;
          } else {
            comp.threshold.setValueAtTime(0, ctx.currentTime);
            comp.knee.setValueAtTime(0, ctx.currentTime);
            comp.ratio.setValueAtTime(1, ctx.currentTime);
            shelf.gain.value = 0;
          }
        }
      }, [phoneBoost]);

      const getPitchColor = () => {
        if (currentPitch === 0) return 'bg-gray-400';
        const target = notes[selectedNote];
        const diff = Math.abs(currentPitch - target);
        if (diff < 5) return 'bg-green-500';
        if (diff < 15) return 'bg-yellow-500';
        return 'bg-red-500';
      };

      const getPitchStatus = () => {
        if (currentPitch === 0) return '---';
        const target = notes[selectedNote];
        const diff = currentPitch - target;
        if (Math.abs(diff) < 5) return `${currentPitch}`;
        if (diff > 0) return `${currentPitch}‚Üì`;
        return `${currentPitch}‚Üë`;
      };

      const getFontSizeClass = () => {
        switch (fontSize) {
          case 'small': return 'text-base';
          case 'large': return 'text-xl';
          case 'xlarge': return 'text-2xl';
          default: return 'text-lg';
        }
      };

      return (
        <div className="min-h-screen safe-top safe-bottom" style={{backgroundColor: 'var(--brand-beige)'}}>
          {/* Header */}
          <header className="safe-top" style={{backgroundColor: 'var(--brand-pink)', color: 'white', boxShadow: '0 4px 20px rgba(255, 162, 254, 0.3)'}}>
            <div className="px-6 py-4">
              <div className="flex flex-col items-center gap-4">
                <h1 className="text-3xl font-bold uppercase tracking-wide text-white drop-shadow-md text-center" style={{fontFamily: "'Averia Serif Libre', serif"}}>üíñ Transfem Voice Training</h1>
                <div className="flex gap-3">
                  <button
                    onClick={() => window.location.href = '../'}
                    className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                    onMouseOver={(e) => {
                      e.target.style.backgroundColor = 'white';
                      e.target.style.color = 'var(--brand-pink)';
                    }}
                    onMouseOut={(e) => {
                      e.target.style.backgroundColor = 'transparent';
                      e.target.style.color = 'white';
                    }}
                  >
                    ‚Üê Back to Main
                  </button>
                  {selectedReading && selectedReading.id === 'exercises-link' && (
                    <button
                      onClick={() => setSelectedReading(null)}
                      className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                      onMouseOver={(e) => {
                        e.target.style.backgroundColor = 'white';
                        e.target.style.color = 'var(--brand-pink)';
                      }}
                      onMouseOut={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                        e.target.style.color = 'white';
                      }}
                    >
                      ‚Üí Switch to Reading
                    </button>
                  )}
                  {!selectedReading && (
                    <button
                      onClick={() => {
                        const exercises = readings.find(r => r.id === 'exercises-link');
                        if (exercises) setSelectedReading(exercises);
                      }}
                      className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                      onMouseOver={(e) => {
                        e.target.style.backgroundColor = 'white';
                        e.target.style.color = 'var(--brand-pink)';
                      }}
                      onMouseOut={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                        e.target.style.color = 'white';
                      }}
                    >
                      ‚Üí Switch to Exercises
                    </button>
                  )}
                </div>
              </div>
            </div>
          </header>

          {/* Main */}
          <div className="p-6 pb-20" style={{minHeight: 'calc(100vh - 100px)'}}>
            {/* Mic permission helper */}
            {micPermission === 'denied' && (
              <div className="mb-4 p-4 bg-red-100 border border-red-300 rounded-lg">
                <p className="text-red-800">üé§ Microphone access required for pitch detection</p>
                <button
                  onClick={initAudio}
                  className="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg"
                >
                  Grant Access
                </button>
              </div>
            )}

            {!selectedReading ? (
              <>
                {/* Reading selection */}
                <div className="bg-white training-card p-8">
                  <h2 className="text-2xl brand-heading mb-6" style={{color: 'var(--brand-grey)'}}>üìö Select Reading Material</h2>
                  <div className="space-y-3">
                    {readings.filter(r => r.id !== 'exercises-link').map((reading) => (
                      <button
                        key={reading.id}
                        onClick={() => setSelectedReading(reading)}
                        className="w-full text-left p-6 border-2 transition-all duration-300 transform hover:-translate-y-1"
                        style={{
                          borderColor: 'var(--brand-pink)',
                          borderRadius: '15px',
                          backgroundColor: 'var(--brand-beige)'
                        }}
                        onMouseOver={(e) => {
                          e.target.style.backgroundColor = 'white';
                          e.target.style.boxShadow = '0 8px 25px rgba(255, 162, 254, 0.2)';
                        }}
                        onMouseOut={(e) => {
                          e.target.style.backgroundColor = 'var(--brand-beige)';
                          e.target.style.boxShadow = 'none';
                        }}
                      >
                        <div className="font-bold text-lg mb-2" style={{color: 'var(--brand-grey)'}}>{reading.title}</div>
                        <div className="text-sm font-medium" style={{color: 'var(--brand-grey)', opacity: '0.8'}}>{reading.description}</div>
                      </button>
                    ))}
                  </div>
                </div>
              </>
            ) : (
              /* Reading view */
              <div className="bg-white training-card p-8">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <button
                      onClick={() => setSelectedReading(null)}
                      className="font-bold uppercase tracking-wide text-sm mb-4 transition-colors"
                      style={{color: 'var(--brand-pink)'}}
                      onMouseOver={(e) => e.target.style.color = 'var(--brand-purple)'}
                      onMouseOut={(e) => e.target.style.color = 'var(--brand-pink)'}
                    >
                      ‚Üê Back to Materials
                    </button>
                  </div>
                  {!selectedReading.isResourceList && (
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          const sizes = ['small', 'medium', 'large', 'xlarge'];
                          const current = sizes.indexOf(fontSize);
                          setFontSize(sizes[(current + 1) % sizes.length]);
                        }}
                        className="px-4 py-2 text-sm font-bold uppercase tracking-wide transition-all duration-300 transform hover:-translate-y-1"
                        style={{
                          borderRadius: '10px',
                          background: 'linear-gradient(135deg, var(--brand-yellow), var(--brand-orange))',
                          color: 'white',
                          boxShadow: '0 4px 15px rgba(253, 213, 90, 0.3)'
                        }}
                      >
                        Aa Size
                      </button>
                    </div>
                  )}
                </div>

                {/* Image if present */}
                {selectedReading.image && (
                  <div className="text-center mb-6">
                    <img
                      src={selectedReading.image}
                      alt={selectedReading.title}
                      style={{
                        maxWidth: '300px',
                        width: '100%',
                        height: 'auto',
                        margin: '0 auto',
                        display: 'block'
                      }}
                    />
                  </div>
                )}

                {/* Title and description centered */}
                <div className="text-center mb-6">
                  <h2 className="text-2xl brand-heading mb-2">{selectedReading.title}</h2>
                  <p className="text-lg font-medium" style={{color: 'var(--brand-grey)', opacity: '0.8'}}>{selectedReading.description}</p>
                </div>

                {selectedReading.isResourceList ? (
                  <div className="space-y-4">
                    {selectedReading.resources.map((resource, index) => (
                      <div
                        key={index}
                        className="p-5 border-2 transition-all duration-300"
                        style={{
                          borderColor: 'var(--brand-pink)',
                          borderRadius: '15px',
                          backgroundColor: 'var(--brand-beige)',
                          boxShadow: '0 2px 10px rgba(255, 162, 254, 0.1)'
                        }}
                      >
                        <div className="mb-3">
                          <div className="font-bold text-lg" style={{color: 'var(--brand-grey)'}}>{resource.title}</div>
                        </div>

                        {resource.isVideo ? (
                          // Single button for video exercises
                          <a
                            href={resource.digitalPage}
                            className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                            style={{
                              backgroundColor: 'var(--brand-purple)',
                              color: 'white',
                              textDecoration: 'none',
                              boxShadow: '0 4px 15px rgba(144, 77, 255, 0.3)'
                            }}
                          >
                            üé¨ Watch Video
                          </a>
                        ) : (
                          // Two-button layout for regular exercises
                          <div className="grid grid-cols-2 gap-3">
                            {/* PDF Button */}
                            <a
                              href={resource.pdfUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                              style={{
                                backgroundColor: 'var(--brand-purple)',
                                color: 'white',
                                textDecoration: 'none',
                                boxShadow: '0 4px 15px rgba(144, 77, 255, 0.3)'
                              }}
                            >
                              üìÑ PDF Printable
                            </a>

                            {/* Digital View Button */}
                            {resource.status === 'available' ? (
                              <a
                                href={resource.digitalPage}
                                className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                                style={{
                                  backgroundColor: 'var(--brand-pink)',
                                  color: 'var(--brand-grey)',
                                  textDecoration: 'none',
                                  boxShadow: '0 4px 15px rgba(255, 162, 254, 0.3)'
                                }}
                              >
                                üì± View in App
                              </a>
                            ) : (
                              <div
                                className="text-center py-3 px-4 rounded-lg font-bold text-sm cursor-not-allowed"
                                style={{
                                  backgroundColor: '#e5e7eb',
                                  color: '#9ca3af'
                                }}
                              >
                                üì± Coming Soon
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className={`reading-text ${getFontSizeClass()} whitespace-pre-wrap`} style={{color: 'var(--brand-grey)'}}>
                    {selectedReading.content}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Floating pitch bubble */}
          {showBubble && (
            <div className="floating-bubble">
              {!bubbleExpanded ? (
                <button
                  onClick={() => {
                    if (!micActive) {
                      activateMicrophone();
                    }
                    setBubbleExpanded(true);
                  }}
                  className={`relative w-20 h-16 rounded-full shadow-lg flex flex-col items-center justify-center text-white font-bold text-sm pitch-indicator ${micActive ? getPitchColor() : 'bg-gray-400'}`}
                  style={{
                    animation: 'pulse 2s infinite',
                    cursor: 'pointer',
                    border: '2px solid rgba(255,255,255,0.5)'
                  }}
                  title={micActive ? "Click to expand controls" : "Click to activate microphone"}
                >
                  <div style={{fontSize: '18px', marginTop: '-4px'}}>
                    {micActive ? getPitchStatus() : 'üîá'}
                  </div>
                  <div style={{fontSize: '10px', marginTop: '2px', opacity: 0.9}}>
                    {micActive ? '‚¨ÜÔ∏è' : 'TAP'}
                  </div>
                </button>
              ) : (
                <div className="bg-white rounded-2xl shadow-xl p-4 w-48">
                  <div className="flex justify-between items-center mb-3">
                    <span className="font-semibold text-sm">Pitch Monitor</span>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setShowSettingsModal(true)}
                        className="text-gray-600 hover:text-purple-600 text-lg"
                        title="Pitch Control Settings"
                      >
                        ‚öôÔ∏è
                      </button>
                      <button
                        onClick={() => setBubbleExpanded(false)}
                        className="text-gray-500 text-xl"
                      >
                        √ó
                      </button>
                    </div>
                  </div>

                  <div className="text-center mb-3">
                    <div className={`text-2xl font-bold ${
                      currentPitch === 0
                        ? 'text-gray-400'
                        : Math.abs(currentPitch - notes[selectedNote]) < 5
                        ? 'text-green-500'
                        : Math.abs(currentPitch - notes[selectedNote]) < 15
                        ? 'text-yellow-500'
                        : 'text-red-500'
                    }`}>
                      {currentPitch > 0 ? `${currentPitch} Hz` : '---'}
                    </div>
                    <div className="text-xs text-gray-500">
                      Target: {selectedNote} ({Math.round(notes[selectedNote])} Hz)
                    </div>
                  </div>

                  <div className="flex gap-2 mb-3">
                    <button
                      onClick={() => adjustNote('down')}
                      className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                    >
                      ‚Üì
                    </button>
                    <button
                      onClick={() => adjustNote('up')}
                      className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                    >
                      ‚Üë
                    </button>
                  </div>

                  <div className="flex gap-2 mb-3">
                    <button
                      onClick={isDronePlaying ? stopDrone : startDrone}
                      className={`flex-1 py-2 rounded-lg text-sm text-white ${
                        isDronePlaying ? 'bg-red-500' : 'bg-green-500'
                      }`}
                    >
                      {isDronePlaying ? 'Mute Drone' : 'Play Drone'}
                    </button>
                  </div>

                  {/* Recording controls (WAV format only) */}
                  <div className="space-y-2">
                    <button
                      onClick={isRecording ? stopRecording : startRecording}
                      disabled={!micActive}
                      className={`w-full py-2 rounded-lg text-sm text-white font-semibold flex items-center justify-center gap-2 ${
                        !micActive ? 'bg-gray-300 cursor-not-allowed' :
                        isRecording ? 'bg-red-600' : 'bg-purple-600'
                      }`}
                      title={!micActive ? 'Activate microphone first' : ''}
                    >
                      {isRecording && <span className="inline-block w-3 h-3 bg-white rounded-full animate-pulse"></span>}
                      {isRecording ? 'Stop Recording' : 'üéôÔ∏è Record'}
                    </button>

                    {lastRecording && (
                      <button
                        onClick={async () => {
                          // Stop mic BEFORE starting playback (critical for iOS volume)
                          stopMicrophoneForPlayback();

                          // Wait a moment for mic to fully release
                          await new Promise(resolve => setTimeout(resolve, 100));

                          const audio = new Audio(lastRecording.url);
                          audio.onpause = restartMicrophoneAfterPlayback;
                          audio.onended = restartMicrophoneAfterPlayback;
                          audio.play();
                        }}
                        className="w-full py-2 rounded-lg text-sm text-white font-semibold bg-pink-500"
                      >
                        ‚ñ∂Ô∏è Replay Last
                      </button>
                    )}

                    {recordings.length > 0 && (
                      <button
                        onClick={() => setShowRecordingsModal(true)}
                        className="w-full py-2 rounded-lg text-sm text-white font-semibold bg-orange-500"
                      >
                        üìã Recordings ({recordings.length})
                      </button>
                    )}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Recordings Modal */}
          {showRecordingsModal && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
              onClick={() => setShowRecordingsModal(false)}
            >
              <div
                className="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden"
                onClick={(e) => e.stopPropagation()}
              >
                {/* Modal Header */}
                <div className="p-4 border-b border-gray-200 flex items-center justify-between" style={{backgroundColor: 'var(--brand-purple)'}}>
                  <h2 className="text-xl font-bold text-white">üéôÔ∏è Your Recordings</h2>
                  <button
                    onClick={() => setShowRecordingsModal(false)}
                    className="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                  >
                    √ó
                  </button>
                </div>

                {/* Warning Message */}
                <div className="p-4 bg-yellow-50 border-b border-yellow-200">
                  <p className="text-sm text-yellow-800">
                    ‚ö†Ô∏è <strong>Note:</strong> Recordings are stored temporarily in your browser. They will be lost when you close this tab or refresh the page.
                  </p>
                </div>

                {/* Recordings List */}
                <div className="p-4 overflow-y-auto max-h-[calc(80vh-200px)]">
                  {recordings.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <div className="text-4xl mb-2">üé§</div>
                      <p>No recordings yet</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {recordings.slice().reverse().map((recording, index) => (
                        <div
                          key={recording.id}
                          className="border-2 rounded-lg p-4 hover:shadow-md transition-shadow"
                          style={{borderColor: 'var(--brand-pink)'}}
                        >
                          <div className="flex items-start justify-between mb-3">
                            <div>
                              <div className="font-semibold" style={{color: 'var(--brand-grey)'}}>
                                Recording #{recordings.length - index}
                              </div>
                              <div className="text-xs text-gray-500">{recording.timestamp}</div>
                            </div>
                          </div>

                          {/* Audio Player */}
                          <audio
                            ref={(el) => { if (el) audioRefs.current[recording.id] = el; }}
                            controls
                            playsinline
                            preload="auto"
                            src={recording.url}
                            className="w-full mb-3"
                            style={{height: '40px'}}
                          />

                          {/* Action Buttons */}
                          <div className="flex gap-2">
                            <button
                              onClick={() => downloadRecording(recording)}
                              className="flex-1 py-2 px-3 rounded-lg text-sm font-semibold text-white"
                              style={{backgroundColor: 'var(--brand-purple)'}}
                            >
                              ‚¨áÔ∏è Download
                            </button>
                            <button
                              onClick={() => {
                                if (window.confirm('Delete this recording?')) {
                                  deleteRecording(recording.id);
                                }
                              }}
                              className="py-2 px-3 rounded-lg text-sm font-semibold text-white bg-red-500"
                            >
                              üóëÔ∏è Delete
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Modal Footer */}
                <div className="p-4 border-t border-gray-200 bg-gray-50">
                  <button
                    onClick={() => setShowRecordingsModal(false)}
                    className="w-full py-2 rounded-lg text-sm font-semibold text-white"
                    style={{backgroundColor: 'var(--brand-grey)'}}
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Pitch Control Settings Modal */}
          {showSettingsModal && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
              onClick={() => setShowSettingsModal(false)}
            >
              <div
                className="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-auto"
                onClick={(e) => e.stopPropagation()}
              >
                {/* Modal Header */}
                <div className="p-4 border-b border-gray-200 flex items-center justify-between" style={{backgroundColor: 'var(--brand-pink)'}}>
                  <h2 className="text-xl font-bold text-white">üéµ Pitch Control Settings</h2>
                  <button
                    onClick={() => setShowSettingsModal(false)}
                    className="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                  >
                    √ó
                  </button>
                </div>

                {/* Modal Content */}
                <div className="p-6 space-y-4">
                  {/* Target Note */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Target Note
                    </label>
                    <select
                      value={selectedNote}
                      onChange={(e) => setSelectedNote(e.target.value)}
                      className="w-full p-3 text-base border-2 font-medium rounded-lg"
                      style={{borderColor: 'var(--brand-pink)', backgroundColor: 'var(--brand-beige)'}}
                    >
                      {Object.entries(notes).map(([note, freq]) => (
                        <option key={note} value={note}>
                          {note} ({Math.round(freq)} Hz)
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Timbre */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Timbre (tone color)
                    </label>
                    <select
                      value={timbre}
                      onChange={(e) => setTimbre(e.target.value)}
                      className="w-full p-3 text-base border-2 font-medium rounded-lg"
                      style={{borderColor: 'var(--brand-pink)', backgroundColor: 'var(--brand-beige)'}}
                    >
                      <option value="sine">Sine ‚Äî soft / pure</option>
                      <option value="triangle">Triangle ‚Äî warm</option>
                      <option value="sawtooth">Saw ‚Äî bright</option>
                      <option value="square">Square ‚Äî hollow</option>
                    </select>
                  </div>

                  {/* Volume slider */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Drone Volume: <span className="font-bold" style={{color: 'var(--brand-pink)'}}>{volumePct}%</span>
                    </label>
                    <input
                      type="range"
                      min="0"
                      max="200"
                      step="5"
                      value={volumePct}
                      onChange={(e) => setVolumePct(parseInt(e.target.value, 10))}
                      className="w-full"
                      aria-label="Drone volume percent"
                      style={{accentColor: 'var(--brand-pink)'}}
                    />
                    <p className="text-xs font-medium mt-1" style={{color: 'var(--brand-grey)', opacity: '0.7'}}>
                      100% = original loudness. 200% = twice the original (safe).
                    </p>
                  </div>

                  {/* Boost / Soften toggles */}
                  <div className="space-y-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={phoneBoost}
                        onChange={(e) => setPhoneBoost(e.target.checked)}
                        className="w-4 h-4"
                        style={{accentColor: 'var(--brand-pink)'}}
                      />
                      <span className="text-sm font-bold uppercase tracking-wide" style={{color: 'var(--brand-grey)'}}>
                        Phone Boost (EQ + compressor)
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={softenHighs}
                        onChange={(e) => setSoftenHighs(e.target.checked)}
                        className="w-4 h-4"
                        style={{accentColor: 'var(--brand-pink)'}}
                      />
                      <span className="text-sm font-bold uppercase tracking-wide" style={{color: 'var(--brand-grey)'}}>
                        Soften highs (less metallic)
                      </span>
                    </label>
                  </div>
                </div>

                {/* Modal Footer */}
                <div className="p-4 border-t border-gray-200 bg-gray-50">
                  <button
                    onClick={() => setShowSettingsModal(false)}
                    className="w-full py-2 rounded-lg text-sm font-semibold text-white"
                    style={{backgroundColor: 'var(--brand-pink)'}}
                  >
                    Done
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<VoiceTrainingReader />);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#904dff" />
  <title>Formation Vocale Française</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="../manifest.json" />

  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="../assets/Visuals/icones/Logo/logosquare.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Voice Trainer" />

  <!-- React / Babel / Tailwind -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- WebAudioRecorder.js Library -->
  <script src="../js/WebAudioRecorder.min.js"></script>

  <!-- Voice Audio Core - Shared audio engine (v2.6) -->
  <script src="../js/voice-audio-core.js"></script>

  <!-- Averia Serif Libre Font -->
  <link href="https://fonts.googleapis.com/css2?family=Averia+Serif+Libre:wght@700&display=swap" rel="stylesheet">

  <style>
    /* Custom CSS Variables for Brand Colors */
    :root {
      --brand-purple: #904dff;
      --brand-orange: #ff722f;
      --brand-pink: #ffa2fe;
      --brand-yellow: #fdd55a;
      --brand-beige: #fff4f2;
      --brand-grey: #3b1e36;
      --brand-blue: #6f81ff;
    }

    /* Dyslexia-friendly spacing; keep the simple, readable sans font you chose */
    .reading-text {
      font-family: Arial, Helvetica, sans-serif;
      line-height: 2;
      letter-spacing: 0.05em;
      word-spacing: 0.2em;
    }

    html { scroll-behavior: smooth; }

    /* Touch targets */
    button { min-height: 44px; min-width: 44px; }

    /* Cards with rounded corners */
    .training-card {
      transition: all 0.3s ease;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(59, 30, 54, 0.1);
    }

    .training-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(59, 30, 54, 0.15);
    }

    /* Floating bubble */
    .floating-bubble {
      position: fixed;
      right: 20px;
      bottom: 80px;
      z-index: 1000;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    .pitch-indicator { transition: all 0.3s ease; }

    /* Prevent accidental selection */
    button {
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Typography */
    .brand-heading {
      font-weight: 700;
      color: var(--brand-grey);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* iOS safe areas */
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    function VoiceTrainingReader() {
      // UI-only state (not audio-related)
      const [showBubble, setShowBubble] = useState(true); // Auto-show monitor
      const [bubbleExpanded, setBubbleExpanded] = useState(false);
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [selectedReading, setSelectedReading] = useState(null);
      const [fontSize, setFontSize] = useState('large');
      const [showRecordingsModal, setShowRecordingsModal] = useState(false);

      // Use shared audio engine (v2.6)
      const audio = useVoiceAudio(showRecordingsModal);

      // Destructure audio API for convenience
      const {
        isDronePlaying,
        selectedNote,
        currentPitch,
        micPermission,
        audioInitialized,
        micActive,
        isRecording,
        recordings,
        lastRecording,
        volumePct,
        timbre,
        softenHighs,
        phoneBoost,
        setVolumePct,
        setTimbre,
        setSoftenHighs,
        setPhoneBoost,
        setSelectedNote,
        activateMicrophone,
        togglePitchMonitor,
        startDrone,
        stopDrone,
        adjustNote,
        startRecording,
        stopRecording,
        deleteRecording,
        downloadRecording,
        audioRefs,
        notes,
        baseGain
      } = audio;

      /* Check URL params on load to auto-select exercises */
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('section') === 'exercises') {
          const exercisesReading = readings.find(r => r.id === 'exercises-link');
          if (exercisesReading) {
            setSelectedReading(exercisesReading);
          }
        }
      }, []);

      /* French Voice Training Readings */
      const readings = [
        {
          id: 'voyage-alice',
          title: "Le voyage d'Alice",
          description: 'Texte français pour la prononciation',
          image: '../assets/Visuals/icones/French/Le voyageAlice.png',
          content: `Lundi matin, Alice et son Papa vont à Malibou. Là-bas, ils rejoignent Papy après un voyage sans soucis.

Il fait chaud, mais la brise légère et l'air iodé de la mer les ravivent. Vers midi, Alice s'exclame: « J'ai vraiment très très faim! » Papy les guide alors vite vers un café luxueux au bord de l'eau: Le Bigorneau Salé.

Mardi, ils vont à la plage. Il n'y a pas un nuage dans le ciel. Papa s'interroge: « Avons-nous pris la crème solaire?» «Bien sûr! » répond Alice.

Mercredi, Papa et Papy se baladent en bavardant. Pendant ce temps, Alice se détend en lisant un roman et mange un bonbon à l'ananas.

Jeudi, elle va faire un jogging. Papa lui crie : «Nous partons faire quelques achats! » Au magasin, Papy achète des noix de macadamia.

Vendredi, ils visitent un musée d'art abstrait. Papa s'extasie devant un splendide tableau et demande: « Qui a donc créé cette oeuvre? »

Samedi matin, Alice s'entraîne pour la soirée karaoké en répétant rapidement : « pataka pataka pataka».

Samedi soir, ils fêtent leur départ en dansant la java sous le lilas. Comme à l'arrivée, il fait chaud, mais la brise légère et l'air iodé de la mer les ravivent.

Dimanche, Alice, Papa et Papy quittent Malibou. Ils rentrent affamés. À table, il y a de la pizza garnie et des lasagnes aux champignons. Rassasiés, ils s'exclament: « Quel séjour extraordinaire ! »`
        },
        {
          id: 'exercises-link',
          title: '📋 Ressources d\'Exercices',
          description: 'Matériel et guides de pratique supplémentaires',
          content: 'RESOURCES',
          isResourceList: true,
          resources: [
            { title: 'Voyelles Féminines', pdfUrl: 'https://drive.google.com/file/d/14d49tx9VNSNMjyBhLPQyuTKHXWfqBXT4/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Le Voyage d\'Alice', pdfUrl: 'https://drive.google.com/file/d/1R36aSzK70r3e2rx_XKOCltoiiP6zfAnw/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Consonnes Phonétiques du Français', pdfUrl: 'https://drive.google.com/file/d/1lx-GcqKB7thVSMZscyGvMcr70QlIUKVx/view?usp=drive_link', status: 'coming-soon' }
          ]
        }
      ];

      // UI helper functions
      const handleTogglePitchMonitor = useCallback(async () => {
        await togglePitchMonitor();
        setShowBubble(true);
      }, [togglePitchMonitor]);

      const getPitchColor = () => {
        if (currentPitch === 0) return 'bg-gray-400';
        const target = notes[selectedNote];
        const diff = Math.abs(currentPitch - target);
        if (diff < 5) return 'bg-green-500';
        if (diff < 15) return 'bg-yellow-500';
        return 'bg-red-500';
      };

      const getPitchStatus = () => {
        if (currentPitch === 0) return '---';
        const target = notes[selectedNote];
        const diff = currentPitch - target;
        if (Math.abs(diff) < 5) return `${currentPitch}`;
        if (diff > 0) return `${currentPitch}↓`;
        return `${currentPitch}↑`;
      };

      const getFontSizeClass = () => {
        switch (fontSize) {
          case 'small': return 'text-base';
          case 'large': return 'text-xl';
          case 'xlarge': return 'text-2xl';
          default: return 'text-lg';
        }
      };

      return (
        <div className="min-h-screen safe-top safe-bottom" style={{backgroundColor: 'var(--brand-beige)'}}>
          {/* Header */}
          <header className="safe-top" style={{backgroundColor: 'var(--brand-pink)', color: 'white', boxShadow: '0 4px 20px rgba(255, 162, 254, 0.3)'}}>
            <div className="px-6 py-4">
              <div className="flex flex-col items-center gap-4">
                <h1 className="text-3xl font-bold uppercase tracking-wide text-white drop-shadow-md text-center" style={{fontFamily: "'Averia Serif Libre', serif"}}>🇫🇷 Formation Vocale</h1>
                <div className="flex gap-3">
                  <button
                    onClick={() => window.location.href = '../'}
                    className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                    onMouseOver={(e) => {
                      e.target.style.backgroundColor = 'white';
                      e.target.style.color = 'var(--brand-pink)';
                    }}
                    onMouseOut={(e) => {
                      e.target.style.backgroundColor = 'transparent';
                      e.target.style.color = 'white';
                    }}
                  >
                    ← Back to Main
                  </button>
                  {selectedReading && selectedReading.id === 'exercises-link' && (
                    <button
                      onClick={() => setSelectedReading(null)}
                      className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                      onMouseOver={(e) => {
                        e.target.style.backgroundColor = 'white';
                        e.target.style.color = 'var(--brand-pink)';
                      }}
                      onMouseOut={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                        e.target.style.color = 'white';
                      }}
                    >
                      → Switch to Reading
                    </button>
                  )}
                  {!selectedReading && (
                    <button
                      onClick={() => {
                        const exercises = readings.find(r => r.id === 'exercises-link');
                        if (exercises) setSelectedReading(exercises);
                      }}
                      className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                      onMouseOver={(e) => {
                        e.target.style.backgroundColor = 'white';
                        e.target.style.color = 'var(--brand-pink)';
                      }}
                      onMouseOut={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                        e.target.style.color = 'white';
                      }}
                    >
                      → Switch to Exercises
                    </button>
                  )}
                </div>
              </div>
            </div>
          </header>

          {/* Main */}
          <div className="p-6 pb-20" style={{minHeight: 'calc(100vh - 100px)'}}>
            {/* Mic permission helper */}
            {micPermission === 'denied' && (
              <div className="mb-4 p-4 bg-red-100 border border-red-300 rounded-lg">
                <p className="text-red-800">🎤 Microphone access required for pitch detection</p>
                <button
                  onClick={initAudio}
                  className="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg"
                >
                  Grant Access
                </button>
              </div>
            )}

            {!selectedReading ? (
              <>
                {/* Reading selection */}
                <div className="bg-white training-card p-8">
                  <h2 className="text-2xl brand-heading mb-6" style={{color: 'var(--brand-grey)'}}>📚 Select Reading Material</h2>
                  <div className="space-y-3">
                    {readings.filter(r => r.id !== 'exercises-link').map((reading) => (
                      <button
                        key={reading.id}
                        onClick={() => setSelectedReading(reading)}
                        className="w-full text-left p-6 border-2 transition-all duration-300 transform hover:-translate-y-1"
                        style={{
                          borderColor: 'var(--brand-pink)',
                          borderRadius: '15px',
                          backgroundColor: 'var(--brand-beige)'
                        }}
                        onMouseOver={(e) => {
                          e.target.style.backgroundColor = 'white';
                          e.target.style.boxShadow = '0 8px 25px rgba(255, 162, 254, 0.2)';
                        }}
                        onMouseOut={(e) => {
                          e.target.style.backgroundColor = 'var(--brand-beige)';
                          e.target.style.boxShadow = 'none';
                        }}
                      >
                        <div className="font-bold text-lg mb-2" style={{color: 'var(--brand-grey)'}}>{reading.title}</div>
                        <div className="text-sm font-medium" style={{color: 'var(--brand-grey)', opacity: '0.8'}}>{reading.description}</div>
                      </button>
                    ))}
                  </div>
                </div>
              </>
            ) : (
              /* Reading view */
              <div className="bg-white training-card p-8">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <button
                      onClick={() => setSelectedReading(null)}
                      className="font-bold uppercase tracking-wide text-sm mb-4 transition-colors"
                      style={{color: 'var(--brand-pink)'}}
                      onMouseOver={(e) => e.target.style.color = 'var(--brand-purple)'}
                      onMouseOut={(e) => e.target.style.color = 'var(--brand-pink)'}
                    >
                      ← Back to Materials
                    </button>
                  </div>
                  {!selectedReading.isResourceList && (
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          const sizes = ['small', 'medium', 'large', 'xlarge'];
                          const current = sizes.indexOf(fontSize);
                          setFontSize(sizes[(current + 1) % sizes.length]);
                        }}
                        className="px-4 py-2 text-sm font-bold uppercase tracking-wide transition-all duration-300 transform hover:-translate-y-1"
                        style={{
                          borderRadius: '10px',
                          background: 'linear-gradient(135deg, var(--brand-yellow), var(--brand-orange))',
                          color: 'white',
                          boxShadow: '0 4px 15px rgba(253, 213, 90, 0.3)'
                        }}
                      >
                        Aa Size
                      </button>
                    </div>
                  )}
                </div>

                {/* Image if present */}
                {selectedReading.image && (
                  <div className="text-center mb-6">
                    <img
                      src={selectedReading.image}
                      alt={selectedReading.title}
                      style={{
                        maxWidth: '300px',
                        width: '100%',
                        height: 'auto',
                        margin: '0 auto',
                        display: 'block'
                      }}
                    />
                  </div>
                )}

                {/* Title and description centered */}
                <div className="text-center mb-6">
                  <h2 className="text-2xl brand-heading mb-2">{selectedReading.title}</h2>
                  <p className="text-lg font-medium" style={{color: 'var(--brand-grey)', opacity: '0.8'}}>{selectedReading.description}</p>
                </div>

                {selectedReading.isResourceList ? (
                  <div className="space-y-4">
                    {selectedReading.resources.map((resource, index) => (
                      <div
                        key={index}
                        className="p-5 border-2 transition-all duration-300"
                        style={{
                          borderColor: 'var(--brand-pink)',
                          borderRadius: '15px',
                          backgroundColor: 'var(--brand-beige)',
                          boxShadow: '0 2px 10px rgba(255, 162, 254, 0.1)'
                        }}
                      >
                        <div className="mb-3">
                          <div className="font-bold text-lg" style={{color: 'var(--brand-grey)'}}>{resource.title}</div>
                        </div>

                        {resource.isVideo ? (
                          // Single button for video exercises
                          <a
                            href={resource.digitalPage}
                            className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                            style={{
                              backgroundColor: 'var(--brand-purple)',
                              color: 'white',
                              textDecoration: 'none',
                              boxShadow: '0 4px 15px rgba(144, 77, 255, 0.3)'
                            }}
                          >
                            🎬 Watch Video
                          </a>
                        ) : (
                          // Two-button layout for regular exercises
                          <div className="grid grid-cols-2 gap-3">
                            {/* PDF Button */}
                            <a
                              href={resource.pdfUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                              style={{
                                backgroundColor: 'var(--brand-purple)',
                                color: 'white',
                                textDecoration: 'none',
                                boxShadow: '0 4px 15px rgba(144, 77, 255, 0.3)'
                              }}
                            >
                              📄 PDF Printable
                            </a>

                            {/* Digital View Button */}
                            {resource.status === 'available' ? (
                              <a
                                href={resource.digitalPage}
                                className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                                style={{
                                  backgroundColor: 'var(--brand-pink)',
                                  color: 'var(--brand-grey)',
                                  textDecoration: 'none',
                                  boxShadow: '0 4px 15px rgba(255, 162, 254, 0.3)'
                                }}
                              >
                                📱 View in App
                              </a>
                            ) : (
                              <div
                                className="text-center py-3 px-4 rounded-lg font-bold text-sm cursor-not-allowed"
                                style={{
                                  backgroundColor: '#e5e7eb',
                                  color: '#9ca3af'
                                }}
                              >
                                📱 Coming Soon
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className={`reading-text ${getFontSizeClass()} whitespace-pre-wrap`} style={{color: 'var(--brand-grey)'}}>
                    {selectedReading.content}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Floating pitch bubble */}
          {showBubble && (
            <div className="floating-bubble">
              {!bubbleExpanded ? (
                <button
                  onClick={() => {
                    if (!micActive) {
                      activateMicrophone();
                    }
                    setBubbleExpanded(true);
                  }}
                  className={`relative w-20 h-16 rounded-full shadow-lg flex flex-col items-center justify-center text-white font-bold text-sm pitch-indicator ${micActive ? getPitchColor() : 'bg-gray-400'}`}
                  style={{
                    animation: 'pulse 2s infinite',
                    cursor: 'pointer',
                    border: '2px solid rgba(255,255,255,0.5)'
                  }}
                  title={micActive ? "Click to expand controls" : "Click to activate microphone"}
                >
                  <div style={{fontSize: '18px', marginTop: '-4px'}}>
                    {micActive ? getPitchStatus() : '🔇'}
                  </div>
                  <div style={{fontSize: '10px', marginTop: '2px', opacity: 0.9}}>
                    {micActive ? '⬆️' : 'TAP'}
                  </div>
                </button>
              ) : (
                <div className="bg-white rounded-2xl shadow-xl p-4 w-48">
                  <div className="flex justify-between items-center mb-3">
                    <span className="font-semibold text-sm">Pitch Monitor</span>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setShowSettingsModal(true)}
                        className="text-gray-600 hover:text-purple-600 text-lg"
                        title="Pitch Control Settings"
                      >
                        ⚙️
                      </button>
                      <button
                        onClick={() => setBubbleExpanded(false)}
                        className="text-gray-500 text-xl"
                      >
                        ×
                      </button>
                    </div>
                  </div>

                  <div className="text-center mb-3">
                    <div className={`text-2xl font-bold ${
                      currentPitch === 0
                        ? 'text-gray-400'
                        : Math.abs(currentPitch - notes[selectedNote]) < 5
                        ? 'text-green-500'
                        : Math.abs(currentPitch - notes[selectedNote]) < 15
                        ? 'text-yellow-500'
                        : 'text-red-500'
                    }`}>
                      {currentPitch > 0 ? `${currentPitch} Hz` : '---'}
                    </div>
                    <div className="text-xs text-gray-500">
                      Target: {selectedNote} ({Math.round(notes[selectedNote])} Hz)
                    </div>
                  </div>

                  <div className="flex gap-2 mb-3">
                    <button
                      onClick={() => adjustNote('down')}
                      className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                    >
                      ↓
                    </button>
                    <button
                      onClick={() => adjustNote('up')}
                      className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                    >
                      ↑
                    </button>
                  </div>

                  <div className="flex gap-2 mb-3">
                    <button
                      onClick={isDronePlaying ? stopDrone : startDrone}
                      className={`flex-1 py-2 rounded-lg text-sm text-white ${
                        isDronePlaying ? 'bg-red-500' : 'bg-green-500'
                      }`}
                    >
                      {isDronePlaying ? 'Mute Drone' : 'Play Drone'}
                    </button>
                  </div>

                  {/* Recording controls (WAV format only) */}
                  <div className="space-y-2">
                    <button
                      onClick={isRecording ? stopRecording : startRecording}
                      className={`w-full py-2 rounded-lg text-sm text-white font-semibold flex items-center justify-center gap-2 ${
                        isRecording ? 'bg-red-600' : 'bg-purple-600'
                      }`}
                    >
                      {isRecording && <span className="inline-block w-3 h-3 bg-white rounded-full animate-pulse"></span>}
                      {isRecording ? 'Stop Recording' : '🎙️ Record'}
                    </button>

                    {lastRecording && (
                      <button
                        onClick={async () => {
                          // Stop mic BEFORE starting playback (critical for iOS volume)
                          stopMicrophoneForPlayback();

                          // Wait for mic to fully release (Safari needs time to update audio route)
                          await new Promise(resolve => setTimeout(resolve, 200));

                          const audio = new Audio(lastRecording.url);
                          // Only restart on ended (not pause - that causes duplicate restarts)
                          audio.onended = restartMicrophoneAfterPlayback;
                          audio.play();
                        }}
                        className="w-full py-2 rounded-lg text-sm text-white font-semibold bg-pink-500"
                      >
                        ▶️ Replay Last
                      </button>
                    )}

                    {recordings.length > 0 && (
                      <button
                        onClick={() => setShowRecordingsModal(true)}
                        className="w-full py-2 rounded-lg text-sm text-white font-semibold bg-orange-500"
                      >
                        📋 Recordings ({recordings.length})
                      </button>
                    )}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Recordings Modal */}
          {showRecordingsModal && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
              onClick={() => setShowRecordingsModal(false)}
            >
              <div
                className="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden"
                onClick={(e) => e.stopPropagation()}
              >
                {/* Modal Header */}
                <div className="p-4 border-b border-gray-200 flex items-center justify-between" style={{backgroundColor: 'var(--brand-purple)'}}>
                  <h2 className="text-xl font-bold text-white">🎙️ Your Recordings</h2>
                  <button
                    onClick={() => setShowRecordingsModal(false)}
                    className="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                  >
                    ×
                  </button>
                </div>

                {/* Warning Message */}
                <div className="p-4 bg-yellow-50 border-b border-yellow-200">
                  <p className="text-sm text-yellow-800">
                    ⚠️ <strong>Note:</strong> Recordings are stored temporarily in your browser. They will be lost when you close this tab or refresh the page.
                  </p>
                </div>

                {/* Recordings List */}
                <div className="p-4 overflow-y-auto max-h-[calc(80vh-200px)]">
                  {recordings.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <div className="text-4xl mb-2">🎤</div>
                      <p>No recordings yet</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {recordings.slice().reverse().map((recording, index) => (
                        <div
                          key={recording.id}
                          className="border-2 rounded-lg p-4 hover:shadow-md transition-shadow"
                          style={{borderColor: 'var(--brand-pink)'}}
                        >
                          <div className="flex items-start justify-between mb-3">
                            <div>
                              <div className="font-semibold" style={{color: 'var(--brand-grey)'}}>
                                Recording #{recordings.length - index}
                              </div>
                              <div className="text-xs text-gray-500">{recording.timestamp}</div>
                            </div>
                          </div>

                          {/* Audio Player */}
                          <audio
                            ref={(el) => { if (el) audioRefs.current[recording.id] = el; }}
                            controls
                            playsinline
                            preload="auto"
                            src={recording.url}
                            className="w-full mb-3"
                            style={{height: '40px'}}
                          />

                          {/* Action Buttons */}
                          <div className="flex gap-2">
                            <button
                              onClick={() => downloadRecording(recording)}
                              className="flex-1 py-2 px-3 rounded-lg text-sm font-semibold text-white"
                              style={{backgroundColor: 'var(--brand-purple)'}}
                            >
                              ⬇️ Download
                            </button>
                            <button
                              onClick={() => {
                                if (window.confirm('Delete this recording?')) {
                                  deleteRecording(recording.id);
                                }
                              }}
                              className="py-2 px-3 rounded-lg text-sm font-semibold text-white bg-red-500"
                            >
                              🗑️ Delete
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Modal Footer */}
                <div className="p-4 border-t border-gray-200 bg-gray-50">
                  <button
                    onClick={() => setShowRecordingsModal(false)}
                    className="w-full py-2 rounded-lg text-sm font-semibold text-white"
                    style={{backgroundColor: 'var(--brand-grey)'}}
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Pitch Control Settings Modal */}
          {showSettingsModal && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
              onClick={() => setShowSettingsModal(false)}
            >
              <div
                className="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-auto"
                onClick={(e) => e.stopPropagation()}
              >
                {/* Modal Header */}
                <div className="p-4 border-b border-gray-200 flex items-center justify-between" style={{backgroundColor: 'var(--brand-pink)'}}>
                  <h2 className="text-xl font-bold text-white">🎵 Pitch Control Settings</h2>
                  <button
                    onClick={() => setShowSettingsModal(false)}
                    className="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                  >
                    ×
                  </button>
                </div>

                {/* Modal Content */}
                <div className="p-6 space-y-4">
                  {/* Target Note */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Target Note
                    </label>
                    <select
                      value={selectedNote}
                      onChange={(e) => setSelectedNote(e.target.value)}
                      className="w-full p-3 text-base border-2 font-medium rounded-lg"
                      style={{borderColor: 'var(--brand-pink)', backgroundColor: 'var(--brand-beige)'}}
                    >
                      {Object.entries(notes).map(([note, freq]) => (
                        <option key={note} value={note}>
                          {note} ({Math.round(freq)} Hz)
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Timbre */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Timbre (tone color)
                    </label>
                    <select
                      value={timbre}
                      onChange={(e) => setTimbre(e.target.value)}
                      className="w-full p-3 text-base border-2 font-medium rounded-lg"
                      style={{borderColor: 'var(--brand-pink)', backgroundColor: 'var(--brand-beige)'}}
                    >
                      <option value="sine">Sine — soft / pure</option>
                      <option value="triangle">Triangle — warm</option>
                      <option value="sawtooth">Saw — bright</option>
                      <option value="square">Square — hollow</option>
                    </select>
                  </div>

                  {/* Volume slider */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Drone Volume: <span className="font-bold" style={{color: 'var(--brand-pink)'}}>{volumePct}%</span>
                    </label>
                    <input
                      type="range"
                      min="0"
                      max="200"
                      step="5"
                      value={volumePct}
                      onChange={(e) => setVolumePct(parseInt(e.target.value, 10))}
                      className="w-full"
                      aria-label="Drone volume percent"
                      style={{accentColor: 'var(--brand-pink)'}}
                    />
                    <p className="text-xs font-medium mt-1" style={{color: 'var(--brand-grey)', opacity: '0.7'}}>
                      100% = original loudness. 200% = twice the original (safe).
                    </p>
                  </div>

                  {/* Boost / Soften toggles */}
                  <div className="space-y-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={phoneBoost}
                        onChange={(e) => setPhoneBoost(e.target.checked)}
                        className="w-4 h-4"
                        style={{accentColor: 'var(--brand-pink)'}}
                      />
                      <span className="text-sm font-bold uppercase tracking-wide" style={{color: 'var(--brand-grey)'}}>
                        Phone Boost (EQ + compressor)
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={softenHighs}
                        onChange={(e) => setSoftenHighs(e.target.checked)}
                        className="w-4 h-4"
                        style={{accentColor: 'var(--brand-pink)'}}
                      />
                      <span className="text-sm font-bold uppercase tracking-wide" style={{color: 'var(--brand-grey)'}}>
                        Soften highs (less metallic)
                      </span>
                    </label>
                  </div>
                </div>

                {/* Modal Footer */}
                <div className="p-4 border-t border-gray-200 bg-gray-50">
                  <button
                    onClick={() => setShowSettingsModal(false)}
                    className="w-full py-2 rounded-lg text-sm font-semibold text-white"
                    style={{backgroundColor: 'var(--brand-pink)'}}
                  >
                    Done
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<VoiceTrainingReader />);
  </script>
</body>
</html>
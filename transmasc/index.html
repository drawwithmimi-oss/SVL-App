<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#904dff" />
  <title>Voice Training Companion - Transmasc Edition</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="../manifest.json" />

  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="../assets/Visuals/icones/Logo/logosquare.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Voice Trainer" />

  <!-- React / Babel / Tailwind -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Averia Serif Libre Font -->
  <link href="https://fonts.googleapis.com/css2?family=Averia+Serif+Libre:wght@700&display=swap" rel="stylesheet">

  <style>
    /* Custom CSS Variables for Brand Colors */
    :root {
      --brand-purple: #904dff;
      --brand-orange: #ff722f;
      --brand-pink: #ffa2fe;
      --brand-yellow: #fdd55a;
      --brand-beige: #fff4f2;
      --brand-grey: #3b1e36;
      --brand-blue: #6f81ff;
    }

    /* Dyslexia-friendly spacing; keep the simple, readable sans font you chose */
    .reading-text {
      font-family: Arial, Helvetica, sans-serif;
      line-height: 2;
      letter-spacing: 0.05em;
      word-spacing: 0.2em;
    }

    html { scroll-behavior: smooth; }

    /* Touch targets */
    button { min-height: 44px; min-width: 44px; }

    /* Cards with rounded corners */
    .training-card {
      transition: all 0.3s ease;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(59, 30, 54, 0.1);
    }

    .training-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(59, 30, 54, 0.15);
    }

    /* Floating bubble */
    .floating-bubble {
      position: fixed;
      right: 20px;
      bottom: 80px;
      z-index: 1000;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .pitch-indicator { transition: all 0.3s ease; }

    /* Prevent accidental selection */
    button {
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Typography */
    .brand-heading {
      font-weight: 700;
      color: var(--brand-grey);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* iOS safe areas */
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    function VoiceTrainingReader() {
      const [isDronePlaying, setIsDronePlaying] = useState(false);
      const [selectedNote, setSelectedNote] = useState('C4');
      const [currentPitch, setCurrentPitch] = useState(0);
      const [micPermission, setMicPermission] = useState('pending');
      const [audioInitialized, setAudioInitialized] = useState(false);
      const [micActive, setMicActive] = useState(false);
      const [showBubble, setShowBubble] = useState(true); // Auto-show monitor
      const [bubbleExpanded, setBubbleExpanded] = useState(false);
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [selectedReading, setSelectedReading] = useState(null);
      const [fontSize, setFontSize] = useState('large');

      // Recording state
      const [isRecording, setIsRecording] = useState(false);
      const [recordings, setRecordings] = useState([]);
      const [lastRecording, setLastRecording] = useState(null);
      const [showRecordingsModal, setShowRecordingsModal] = useState(false);
      const mediaRecorderRef = useRef(null);
      const recordingChunksRef = useRef([]);

      /* Check URL params on load to auto-select exercises */
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('section') === 'exercises') {
          const exercisesReading = readings.find(r => r.id === 'exercises-link');
          if (exercisesReading) {
            setSelectedReading(exercisesReading);
          }
        }
      }, []);

      /* Volume 0‚Äì200% of safe base gain (0.2) */
      const [volumePct, setVolumePct] = useState(100);
      const baseGain = 0.2;

      /* NEW: timbre + gentle loudness helpers */
      const [timbre, setTimbre] = useState('sine');      // sine, triangle, sawtooth, square
      const [softenHighs, setSoftenHighs] = useState(true); // lowpass to avoid "metallic"
      const [phoneBoost, setPhoneBoost] = useState(false);  // EQ + compressor for phones

      const audioContextRef = useRef(null);
      const oscillatorRef   = useRef(null);
      const gainNodeRef     = useRef(null);
      const analyserRef     = useRef(null);
      const micStreamRef    = useRef(null);
      const pitchDetectionRef = useRef(null);

      /* NEW: processing nodes so we can tweak live */
      const lowpassRef   = useRef(null);  // soften highs
      const highshelfRef = useRef(null);  // gentle clarity bump when boost on
      const compressorRef= useRef(null);  // loudness control for phones

      const notes = {
        'A3': 220.00, 'B3': 246.94, 'C4': 261.63, 'C#4': 277.18, 'D4': 293.66,
        'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00
      };

      /* Transmasc Voice Training Readings */
      const readings = [
        {
          id: 'rainbow',
          title: 'Rainbow Passage',
          description: 'Classic voice training text',
          image: '../assets/Visuals/icones/Transfemme/Prism - rainbow passage.png',
          content: `When the sunlight strikes raindrops in the air, they act as a prism and form a rainbow. The rainbow is a division of white light into many beautiful colors. These take the shape of a long round arch, with its path high above, and its two ends apparently beyond the horizon. There is, according to legend, a boiling pot of gold at one end. People look, but no one ever finds it. When a person looks for something beyond their reach, their friends say they are looking for the pot of gold at the end of the rainbow.

Throughout the centuries people have explained the rainbow in various ways. Some have accepted it as a miracle without physical explanation. Others have tried to explain the phenomenon physically. Aristotle thought that the rainbow was caused by reflection of the sun's rays by the rain. Since then physicists have found that it is not reflection, but refraction by the raindrops which causes the rainbows.

Many complicated ideas about the rainbow have been formed. The difference in the rainbow depends considerably upon the size of the drops, and the width of the colored band increases as the size of the drops increases. The actual primary rainbow observed is said to be the effect of superimposition of a number of bows. If the red of the second bow falls upon the green of the first, the result is a bow with an abnormally wide yellow band, since red and green light when mixed form yellow. This is a very common type of bow, one showing mainly red and yellow, with little or no green or blue.`
        },
        {
          id: 'grandfather',
          title: 'Grandfather Passage',
          description: 'Standard practice text',
          image: '../assets/Visuals/icones/Transmasc/Grandfather Passage.png',
          content: `You wish to know all about my grandfather. Well, he is nearly 93 years old, yet he still thinks as swiftly as ever. He usually dresses himself in an old black frock coat with several buttons missing. A long beard clings to his chin, giving those who observe him a pronounced feeling of the utmost respect. When he speaks, his voice is just a bit cracked and quivers. Twice each day he plays skillfully and with zest upon a small organ. Except in the winter when the snow or ice prevents it, he slowly takes short walks in the open air. We have often urged him to walk more and smoke less, but he always answers, "Banana oil!" Grandfather likes to be modern in his language.`
        },
        {
          id: 'syllable-beanstalk',
          title: '"The Beanstalk" by Tara Meddaugh',
          description: 'Syllable Separation',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `See, I didn't...really...think that I'd make it this far up. Although, I've always been a bit of a climber. When I was nine months old, my mom found me sitting on top of the brown cow in the barn one morning. I never considered myself afraid of heights before, but it's not really the climbing up that scares me. It's the getting down, Black Crow...It seemed so easy getting here‚Äîjust put one foot on the branch then another and...Oh, I've tried going down already. I put my foot on a branch, but it's slippery now. See? It's like the sludge at the bottom of the pig trough. And you do not want to be climbing down from the clouds on pig sludge! I'd fly off and land down there in a broken bone pile. And then everyone would just say, "Well, that's Jack. He doesn't know how to climb down, poor boy." And I guess they'd be right.`
        },
        {
          id: 'syllable-theo',
          title: '"What Theo Did" by Debra Neff',
          description: 'Syllable Separation',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `So this afternoon I get to school and Hector and Robert run to tell me what Theo did. A substitute took our morning class because Ms. Radford was sick. When the substitute asked Theo to solve a problem on the board, he said, "I can't, I'm having my midlife crisis." Hector and Robert said everybody laughed and laughed and even the substitute had to laugh but then she told him to do the problem anyway. I wish I'd been there! I would have laughed so hard! Theo is always doing stuff like that. He's a riot.

Anyway, I hung out with Theo after school, and we're standing next to his locker and I go, "I heard what you said to the substitute," and I started laughing. But Theo wasn't laughing. He looked sort of nervous and he said, "I wasn't kidding. I really am having a midlife crisis. My mom says I'm probably going to live to be 26, so now that I'm 13, I'm halfway there. That's a midlife crisis, isn't it?"

I thought he was joking because come on, who lives to be 26? But I could see he was really upset so I'm like, "Dude, you're mom's kidding. People don't die when they're 26. Look at Ms. Radford. She's at least 27." And then he started to cry! Can you believe it? And then I felt like such a jerk for laughing.`
        },
        {
          id: 'tempo-pygmalion',
          title: 'Pygmalion by George Bernard Shaw',
          description: 'Tempo',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `I'm a good girl, I am! I'm only a poor girl, but I'm a good one. If I was asking for any compliment, I'd ask for it decent and respectable. I don't want no balmies teaching me. I'm a good girl I am; and I won't pick up no free-and-easy ways. And I'll talk as I like. You're not my teacher!`
        },
        {
          id: 'tempo-play-wrong',
          title: '"The Play That Goes Wrong"',
          description: 'Tempo',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `Now look, I know we haven't always seen eye to eye. In fact, I'd go so far as to say that at times you have been a most unreasonable employer. But I want to put that all behind us. I've been doing a lot of thinking recently. About life, about this place, about... well, us, really. And I've come to realize something quite important. This estate means everything to me. It always has done. I grew up here, I learned to walk in these very grounds, and if I'm honest... I'd like to die here too. Not soon, obviously. But eventually. When the time comes. What I'm trying to say is... I'd like to make this relationship work.`
        },
        {
          id: 'articulation-schroeder',
          title: 'Schroeder from "Charlie Brown"',
          description: 'Articulation',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `I'm sorry to have to say it to your face, Lucy, but it's true. You're a very crabby person. I know your crabbiness has probably become so natural to you now that you're not even aware when you're being crabby, but it's true just the same. You're a very crabby person and you're crabby to just about everyone you meet. Now I hope you don't mind my saying this, Lucy, and I hope you'll take it in the spirit that it's meant. I think we should be very open to any opportunity to learn more about ourselves. I think Socrates was very right when he said that one of the first rules for anyone in life is 'Know Thyself'. Well, I guess I've said about enough. I hope I haven't offended you or anything.`
        },
        {
          id: 'articulation-there-he-is',
          title: '"There He Is" by Joseph Arnone',
          description: 'Articulation',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `My co-worker is the most annoying guy in the world. I wish to God I wasn't so nice to him when I first started working at my new job. I should have wondered why he was so overly nice at the start. I thought it was just good manners but it was purely desperation. You see, the guy is a douchebag, alright? There, I said it. All the other co-workers round on him like he's diseased and now I'm stuck with him and don't know how to get rid of him. I don't mean to sound mean and I know I probably do but you don't understand. For example, every morning when I get to the office, I go into the break room for my morning cup of coffee, this is my moment, the moment I take before dealing with my loser of a manager and all the other dipsh'ts I have to smile at and report to. It's this one little coffee moment, by myself, in the quiet of my tortured life, that I work up all the strength and courage I need to walk down that pathetic hallway, to my desk. But noooo, I have fantastic Andrew popping in now because he knows, he knows I'm all alone, so he jumps at the opportunity to speak to me with his cheese and fart breath, about whatever it is he did the night before, which is absolutely nothing all that interesting, whatsoever. (imitates Andrew) "I leveled up in my game man, I leveled up!" Who-gives-a-fly-ing-sh't-man?`
        },
        {
          id: 'exercises-link',
          title: 'üìã Exercise Resources',
          description: 'Additional practice materials and guides',
          content: 'RESOURCES',
          isResourceList: true,
          resources: [
            { title: 'Vowel Placement', pdfUrl: 'https://drive.google.com/file/d/1O77UEz7p8dH3KtmUwSMgqWj7B34_3bkT/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Rainbow Passage', pdfUrl: 'https://drive.google.com/file/d/1F0GKKgbnQE7_GnUAXoBt3EIzH8kkpZho/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Masc Monologues', pdfUrl: 'https://drive.google.com/file/d/11ZEbK-BE0OVag_t7HajVZ-9u7tTw74Zi/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Masculine Vowel Chart', pdfUrl: 'https://drive.google.com/file/d/10YC1-trnQ6ss3ApMPH5GVEVH0HbTxRP7/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Masc Vowel Glides', pdfUrl: 'https://drive.google.com/file/d/1wz1z8jr422-0enQEvtTf7un-wXHW4bVv/view?usp=drive_link', status: 'coming-soon' },
            { title: 'FTM Students Syllabus', pdfUrl: 'https://drive.google.com/file/d/1H3jjhw2NqYs-ekJNn383RUExNBZJ2byv/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Grandfather Passage', pdfUrl: 'https://drive.google.com/file/d/17FkG9Wf3Be1txC8nRa7JIK25FN3whnjS/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Consonant Buddies', pdfUrl: 'https://drive.google.com/file/d/13qUGZyE_07MByOMjc3ffqpd41BbAlRCA/view?usp=drive_link', status: 'coming-soon' }
          ]
        }
      ];

      /* Init mic + analyser */
      const initAudio = useCallback(async () => {
        try {
          // Create AudioContext first (iOS requires this before getUserMedia)
          if (!audioContextRef.current) {
            audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
          }

          // iOS/Safari: AudioContext starts suspended, must resume with user gesture
          if (audioContextRef.current.state === 'suspended') {
            await audioContextRef.current.resume();
          }

          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: false,
              noiseSuppression: false,
              autoGainControl: false
            }
          });
          micStreamRef.current = stream;
          setMicPermission('granted');

          const source = audioContextRef.current.createMediaStreamSource(stream);
          analyserRef.current = audioContextRef.current.createAnalyser();
          analyserRef.current.fftSize = 2048;
          source.connect(analyserRef.current);

          setAudioInitialized(true);
          startPitchDetection();
        } catch (err) {
          console.error('Microphone error:', err);
          if (err.name === 'NotAllowedError') {
            setMicPermission('denied');
          } else if (err.name === 'NotFoundError') {
            console.error('No microphone found');
            setMicPermission('denied');
          } else {
            setMicPermission('denied');
          }
        }
      }, []);

      /* Pitch detection (simple dominant-bin) */
      const startPitchDetection = useCallback(() => {
        if (!analyserRef.current || !audioContextRef.current) return;

        const bufferLength = analyserRef.current.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const detect = () => {
          if (!analyserRef.current) return;
          analyserRef.current.getByteFrequencyData(dataArray);

          let maxValue = 0, maxIndex = 0;
          for (let i = 0; i < bufferLength; i++) {
            if (dataArray[i] > maxValue) { maxValue = dataArray[i]; maxIndex = i; }
          }

          if (maxValue > 50) {
            const nyquist = audioContextRef.current.sampleRate / 2;
            const frequency = (maxIndex * nyquist) / bufferLength;
            if (frequency > 80 && frequency < 500) setCurrentPitch(Math.round(frequency));
          } else {
            setCurrentPitch(0);
          }

          pitchDetectionRef.current = requestAnimationFrame(detect);
        };

        detect();
      }, []);

      /* Start/Stop drone */
      const startDrone = useCallback(async () => {
        if (!audioContextRef.current) return;
        try {
          // iOS/Safari unlock on gesture
          if (audioContextRef.current.state === 'suspended') {
            await audioContextRef.current.resume();
          }

          const ctx = audioContextRef.current;
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          const lowpass = ctx.createBiquadFilter();
          const shelf   = ctx.createBiquadFilter();
          const comp    = ctx.createDynamicsCompressor();

          // Timbre + note
          osc.type = timbre;
          osc.frequency.value = notes[selectedNote];

          // Soften metallic edge with a gentle lowpass when enabled
          lowpass.type = 'lowpass';
          lowpass.frequency.value = softenHighs ? 2400 : 18000;
          lowpass.Q.value = 0.7;

          // Subtle clarity for small speakers when "phone boost" is on
          shelf.type = 'highshelf';
          shelf.frequency.value = 2500;
          shelf.gain.value = phoneBoost ? 3 : 0;

          // Dynamics to raise perceived loudness on phones
          if (phoneBoost) {
            comp.threshold.setValueAtTime(-26, ctx.currentTime);
            comp.knee.setValueAtTime(9, ctx.currentTime);
            comp.ratio.setValueAtTime(3, ctx.currentTime);
          } else {
            // Neutral settings (effectively bypass)
            comp.threshold.setValueAtTime(0, ctx.currentTime);
            comp.knee.setValueAtTime(0, ctx.currentTime);
            comp.ratio.setValueAtTime(1, ctx.currentTime);
          }
          comp.attack.setValueAtTime(0.003, ctx.currentTime);
          comp.release.setValueAtTime(0.25, ctx.currentTime);

          // Volume uses base gain scaled by slider (0‚Äì200%)
          gain.gain.value = baseGain * (volumePct / 100);

          // Connect graph: osc -> lowpass -> highshelf -> compressor -> gain -> out
          osc.connect(lowpass);
          lowpass.connect(shelf);
          shelf.connect(comp);
          comp.connect(gain);
          gain.connect(ctx.destination);

          osc.start();

          oscillatorRef.current = osc;
          gainNodeRef.current = gain;
          lowpassRef.current = lowpass;
          highshelfRef.current = shelf;
          compressorRef.current = comp;

          setIsDronePlaying(true);
        } catch (error) {
          console.error('Drone error:', error);
        }
      }, [selectedNote, timbre, softenHighs, phoneBoost, volumePct]);

      const stopDrone = useCallback(() => {
        if (oscillatorRef.current) {
          try { oscillatorRef.current.stop(); } catch {}
          oscillatorRef.current = null;
        }
        gainNodeRef.current = null;
        lowpassRef.current = null;
        highshelfRef.current = null;
        compressorRef.current = null;
        setIsDronePlaying(false);
      }, []);

      const activateMicrophone = useCallback(async () => {
        if (!audioInitialized) {
          await initAudio();
        }
        // Ensure AudioContext is running (iOS requirement)
        if (audioContextRef.current && audioContextRef.current.state === 'suspended') {
          await audioContextRef.current.resume();
        }
        setMicActive(true);
      }, [audioInitialized, initAudio]);

      const togglePitchMonitor = useCallback(async () => {
        if (audioContextRef.current && audioContextRef.current.state === 'suspended') {
          try { await audioContextRef.current.resume(); } catch {}
        }
        setShowBubble(true);
      }, []);

      const adjustNote = useCallback((direction) => {
        const noteArray = Object.keys(notes);
        const currentIndex = noteArray.indexOf(selectedNote);
        let newIndex = direction === 'up' ? currentIndex + 1 : currentIndex - 1;
        newIndex = Math.max(0, Math.min(noteArray.length - 1, newIndex));
        const newNote = noteArray[newIndex];
        setSelectedNote(newNote);

        if (oscillatorRef.current) {
          oscillatorRef.current.frequency.value = notes[newNote];
        }
      }, [selectedNote]);

      /* Keep mic + context lifecycle clean */
      useEffect(() => {
        initAudio();
        // Default: enable boost on small screens
        try {
          if (window.matchMedia && window.matchMedia('(max-width: 480px)').matches) {
            setPhoneBoost(true);
          }
        } catch {}
        return () => {
          if (pitchDetectionRef.current) cancelAnimationFrame(pitchDetectionRef.current);
          if (oscillatorRef.current) { try { oscillatorRef.current.stop(); } catch {} }
          if (micStreamRef.current) micStreamRef.current.getTracks().forEach(t => t.stop());
          if (audioContextRef.current) { try { audioContextRef.current.close(); } catch {} }
        };
      }, [initAudio]);

      /* Live updates while playing */
      useEffect(() => {
        if (gainNodeRef.current) {
          gainNodeRef.current.gain.value = baseGain * (volumePct / 100);
        }
      }, [volumePct]);

      useEffect(() => {
        if (oscillatorRef.current) oscillatorRef.current.type = timbre;
      }, [timbre]);

      useEffect(() => {
        if (oscillatorRef.current) {
          oscillatorRef.current.frequency.value = notes[selectedNote];
        }
      }, [selectedNote]);

      useEffect(() => {
        if (lowpassRef.current) {
          lowpassRef.current.frequency.value = softenHighs ? 2400 : 18000;
        }
      }, [softenHighs]);

      useEffect(() => {
        const ctx = audioContextRef.current;
        if (ctx && compressorRef.current && highshelfRef.current) {
          const comp = compressorRef.current;
          const shelf = highshelfRef.current;
          if (phoneBoost) {
            comp.threshold.setValueAtTime(-26, ctx.currentTime);
            comp.knee.setValueAtTime(9, ctx.currentTime);
            comp.ratio.setValueAtTime(3, ctx.currentTime);
            shelf.gain.value = 3;
          } else {
            comp.threshold.setValueAtTime(0, ctx.currentTime);
            comp.knee.setValueAtTime(0, ctx.currentTime);
            comp.ratio.setValueAtTime(1, ctx.currentTime);
            shelf.gain.value = 0;
          }
        }
      }, [phoneBoost]);

      // Recording functions
      const startRecording = useCallback(async () => {
        if (!micStreamRef.current) {
          console.error('No microphone stream available');
          return;
        }

        try {
          // Ensure AudioContext is running before recording (iOS requirement)
          if (audioContextRef.current && audioContextRef.current.state === 'suspended') {
            await audioContextRef.current.resume();
          }

          recordingChunksRef.current = [];

          // iOS Safari fix: isTypeSupported() returns false for everything on iOS
          // even though MediaRecorder works! Detect iOS/Safari directly.
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
          const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

          let options;
          if (isIOS || (isSafari && !MediaRecorder.isTypeSupported('audio/webm'))) {
            // iOS/Safari: Use empty options to let browser choose (will use mp4/aac)
            options = {};
          } else if (MediaRecorder.isTypeSupported('audio/webm')) {
            options = { mimeType: 'audio/webm' };
          } else {
            options = {}; // Browser default
          }

          const mediaRecorder = new MediaRecorder(micStreamRef.current, options);

          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              recordingChunksRef.current.push(event.data);
            }
          };

          mediaRecorder.onstop = () => {
            const mimeType = mediaRecorder.mimeType || 'audio/webm';
            const blob = new Blob(recordingChunksRef.current, { type: mimeType });
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toLocaleString();
            const newRecording = {
              id: Date.now(),
              timestamp,
              blob,
              url,
              duration: null, // Could calculate if needed
              mimeType
            };

            setRecordings(prev => [...prev, newRecording]);
            setLastRecording(newRecording);
          };

          mediaRecorderRef.current = mediaRecorder;
          mediaRecorder.start();
          setIsRecording(true);
        } catch (error) {
          console.error('Error starting recording:', error);
          alert('Recording failed. Please ensure microphone access is granted and try again.');
        }
      }, []);

      const stopRecording = useCallback(() => {
        if (mediaRecorderRef.current && isRecording) {
          mediaRecorderRef.current.stop();
          setIsRecording(false);
        }
      }, [isRecording]);

      const deleteRecording = useCallback((id) => {
        setRecordings(prev => {
          const recording = prev.find(r => r.id === id);
          if (recording) {
            URL.revokeObjectURL(recording.url);
          }
          return prev.filter(r => r.id !== id);
        });
        if (lastRecording && lastRecording.id === id) {
          setLastRecording(null);
        }
      }, [lastRecording]);

      const downloadRecording = useCallback((recording) => {
        const a = document.createElement('a');
        a.href = recording.url;
        // Determine file extension based on mimeType
        let ext = 'webm';
        if (recording.mimeType) {
          if (recording.mimeType.includes('mp4')) ext = 'mp4';
          else if (recording.mimeType.includes('aac')) ext = 'aac';
          else if (recording.mimeType.includes('m4a')) ext = 'm4a';
        }
        a.download = `voice-recording-${recording.id}.${ext}`;
        a.click();
      }, []);

      const getPitchColor = () => {
        if (currentPitch === 0) return 'bg-gray-400';
        const target = notes[selectedNote];
        const diff = Math.abs(currentPitch - target);
        if (diff < 5) return 'bg-green-500';
        if (diff < 15) return 'bg-yellow-500';
        return 'bg-red-500';
      };

      const getPitchStatus = () => {
        if (currentPitch === 0) return '---';
        const target = notes[selectedNote];
        const diff = currentPitch - target;
        if (Math.abs(diff) < 5) return `${currentPitch}`;
        if (diff > 0) return `${currentPitch}‚Üì`;
        return `${currentPitch}‚Üë`;
      };

      const getFontSizeClass = () => {
        switch (fontSize) {
          case 'small': return 'text-base';
          case 'large': return 'text-xl';
          case 'xlarge': return 'text-2xl';
          default: return 'text-lg';
        }
      };

      return (
        <div className="min-h-screen safe-top safe-bottom" style={{backgroundColor: 'var(--brand-beige)'}}>
          {/* Header */}
          <header className="safe-top" style={{backgroundColor: 'var(--brand-purple)', color: 'white', boxShadow: '0 4px 20px rgba(144, 77, 255, 0.3)'}}>
            <div className="px-6 py-4">
              <div className="flex flex-col items-center gap-4">
                <h1 className="text-3xl font-bold uppercase tracking-wide text-white drop-shadow-md text-center" style={{fontFamily: "'Averia Serif Libre', serif"}}>üíú Transmasc Voice Training</h1>
                <div className="flex gap-3">
                  <button
                    onClick={() => window.location.href = '../'}
                    className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                    onMouseOver={(e) => {
                      e.target.style.backgroundColor = 'white';
                      e.target.style.color = 'var(--brand-purple)';
                    }}
                    onMouseOut={(e) => {
                      e.target.style.backgroundColor = 'transparent';
                      e.target.style.color = 'white';
                    }}
                  >
                    ‚Üê Back to Main
                  </button>
                  {selectedReading && selectedReading.id === 'exercises-link' && (
                    <button
                      onClick={() => setSelectedReading(null)}
                      className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                      onMouseOver={(e) => {
                        e.target.style.backgroundColor = 'white';
                        e.target.style.color = 'var(--brand-purple)';
                      }}
                      onMouseOut={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                        e.target.style.color = 'white';
                      }}
                    >
                      ‚Üí Switch to Reading
                    </button>
                  )}
                  {!selectedReading && (
                    <button
                      onClick={() => {
                        const exercises = readings.find(r => r.id === 'exercises-link');
                        if (exercises) setSelectedReading(exercises);
                      }}
                      className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                      onMouseOver={(e) => {
                        e.target.style.backgroundColor = 'white';
                        e.target.style.color = 'var(--brand-purple)';
                      }}
                      onMouseOut={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                        e.target.style.color = 'white';
                      }}
                    >
                      ‚Üí Switch to Exercises
                    </button>
                  )}
                </div>
              </div>
            </div>
          </header>

          {/* Main */}
          <div className="p-6 pb-20" style={{minHeight: 'calc(100vh - 100px)'}}>
            {/* Mic permission helper */}
            {micPermission === 'denied' && (
              <div className="mb-4 p-4 bg-red-100 border border-red-300 rounded-lg">
                <p className="text-red-800">üé§ Microphone access required for pitch detection</p>
                <button
                  onClick={initAudio}
                  className="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg"
                >
                  Grant Access
                </button>
              </div>
            )}

            {!selectedReading ? (
              <>
                {/* Reading selection */}
                <div className="bg-white training-card p-8">
                  <h2 className="text-2xl brand-heading mb-6" style={{color: 'var(--brand-grey)'}}>üìö Select Reading Material</h2>
                  <div className="space-y-3">
                    {readings.filter(r => r.id !== 'exercises-link').map((reading) => (
                      <button
                        key={reading.id}
                        onClick={() => setSelectedReading(reading)}
                        className="w-full text-left p-6 border-2 transition-all duration-300 transform hover:-translate-y-1"
                        style={{
                          borderColor: 'var(--brand-blue)',
                          borderRadius: '15px',
                          backgroundColor: 'var(--brand-beige)'
                        }}
                        onMouseOver={(e) => {
                          e.target.style.backgroundColor = 'white';
                          e.target.style.boxShadow = '0 8px 25px rgba(111, 129, 255, 0.2)';
                        }}
                        onMouseOut={(e) => {
                          e.target.style.backgroundColor = 'var(--brand-beige)';
                          e.target.style.boxShadow = 'none';
                        }}
                      >
                        <div className="font-bold text-lg mb-2" style={{color: 'var(--brand-grey)'}}>{reading.title}</div>
                        <div className="text-sm font-medium" style={{color: 'var(--brand-grey)', opacity: '0.8'}}>{reading.description}</div>
                      </button>
                    ))}
                  </div>
                </div>
              </>
            ) : (
              /* Reading view */
              <div className="bg-white training-card p-8">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <button
                      onClick={() => setSelectedReading(null)}
                      className="font-bold uppercase tracking-wide text-sm mb-4 transition-colors"
                      style={{color: 'var(--brand-blue)'}}
                      onMouseOver={(e) => e.target.style.color = 'var(--brand-purple)'}
                      onMouseOut={(e) => e.target.style.color = 'var(--brand-blue)'}
                    >
                      ‚Üê Back to Materials
                    </button>
                  </div>
                  {!selectedReading.isResourceList && (
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          const sizes = ['small', 'medium', 'large', 'xlarge'];
                          const current = sizes.indexOf(fontSize);
                          setFontSize(sizes[(current + 1) % sizes.length]);
                        }}
                        className="px-4 py-2 text-sm font-bold uppercase tracking-wide transition-all duration-300 transform hover:-translate-y-1"
                        style={{
                          borderRadius: '10px',
                          background: 'linear-gradient(135deg, var(--brand-yellow), var(--brand-orange))',
                          color: 'white',
                          boxShadow: '0 4px 15px rgba(253, 213, 90, 0.3)'
                        }}
                      >
                        Aa Size
                      </button>
                    </div>
                  )}
                </div>

                {/* Image if present */}
                {selectedReading.image && (
                  <div className="text-center mb-6">
                    <img
                      src={selectedReading.image}
                      alt={selectedReading.title}
                      style={{
                        maxWidth: '300px',
                        width: '100%',
                        height: 'auto',
                        margin: '0 auto',
                        display: 'block'
                      }}
                    />
                  </div>
                )}

                {/* Title and description centered */}
                <div className="text-center mb-6">
                  <h2 className="text-2xl brand-heading mb-2">{selectedReading.title}</h2>
                  <p className="text-lg font-medium" style={{color: 'var(--brand-grey)', opacity: '0.8'}}>{selectedReading.description}</p>
                </div>

                {selectedReading.isResourceList ? (
                  <div className="space-y-4">
                    {selectedReading.resources.map((resource, index) => (
                      <div
                        key={index}
                        className="p-5 border-2 transition-all duration-300"
                        style={{
                          borderColor: 'var(--brand-purple)',
                          borderRadius: '15px',
                          backgroundColor: 'var(--brand-beige)',
                          boxShadow: '0 2px 10px rgba(144, 77, 255, 0.1)'
                        }}
                      >
                        <div className="mb-3">
                          <div className="font-bold text-lg" style={{color: 'var(--brand-grey)'}}>{resource.title}</div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          {/* PDF Button */}
                          <a
                            href={resource.pdfUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                            style={{
                              backgroundColor: 'var(--brand-purple)',
                              color: 'white',
                              textDecoration: 'none',
                              boxShadow: '0 4px 15px rgba(144, 77, 255, 0.3)'
                            }}
                          >
                            üìÑ PDF Printable
                          </a>

                          {/* Digital View Button */}
                          {resource.status === 'available' ? (
                            <a
                              href={resource.digitalPage}
                              className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                              style={{
                                backgroundColor: 'var(--brand-pink)',
                                color: 'var(--brand-grey)',
                                textDecoration: 'none',
                                boxShadow: '0 4px 15px rgba(255, 162, 254, 0.3)'
                              }}
                            >
                              üì± View in App
                            </a>
                          ) : (
                            <div
                              className="text-center py-3 px-4 rounded-lg font-bold text-sm cursor-not-allowed"
                              style={{
                                backgroundColor: '#e5e7eb',
                                color: '#9ca3af'
                              }}
                            >
                              üì± Coming Soon
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className={`reading-text ${getFontSizeClass()} whitespace-pre-wrap`} style={{color: 'var(--brand-grey)'}}>
                    {selectedReading.content}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Floating pitch bubble */}
          {showBubble && (
            <div className="floating-bubble">
              {!bubbleExpanded ? (
                <button
                  onClick={() => {
                    if (!micActive) {
                      activateMicrophone();
                    }
                    setBubbleExpanded(true);
                  }}
                  className={`relative w-20 h-16 rounded-full shadow-lg flex flex-col items-center justify-center text-white font-bold text-sm pitch-indicator ${micActive ? getPitchColor() : 'bg-gray-400'}`}
                  style={{
                    animation: 'pulse 2s infinite',
                    cursor: 'pointer',
                    border: '2px solid rgba(255,255,255,0.5)'
                  }}
                  title={micActive ? "Click to expand controls" : "Click to activate microphone"}
                >
                  <div style={{fontSize: '18px', marginTop: '-4px'}}>
                    {micActive ? getPitchStatus() : 'üîá'}
                  </div>
                  <div style={{fontSize: '10px', marginTop: '2px', opacity: 0.9}}>
                    {micActive ? '‚¨ÜÔ∏è' : 'TAP'}
                  </div>
                </button>
              ) : (
                <div className="bg-white rounded-2xl shadow-xl p-4 w-48">
                  <div className="flex justify-between items-center mb-3">
                    <span className="font-semibold text-sm">Pitch Monitor</span>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setShowSettingsModal(true)}
                        className="text-gray-600 hover:text-purple-600 text-lg"
                        title="Pitch Control Settings"
                      >
                        ‚öôÔ∏è
                      </button>
                      <button
                        onClick={() => setBubbleExpanded(false)}
                        className="text-gray-500 text-xl"
                      >
                        √ó
                      </button>
                    </div>
                  </div>

                  <div className="text-center mb-3">
                    <div className={`text-2xl font-bold ${
                      currentPitch === 0
                        ? 'text-gray-400'
                        : Math.abs(currentPitch - notes[selectedNote]) < 5
                        ? 'text-green-500'
                        : Math.abs(currentPitch - notes[selectedNote]) < 15
                        ? 'text-yellow-500'
                        : 'text-red-500'
                    }`}>
                      {currentPitch > 0 ? `${currentPitch} Hz` : '---'}
                    </div>
                    <div className="text-xs text-gray-500">
                      Target: {selectedNote} ({Math.round(notes[selectedNote])} Hz)
                    </div>
                  </div>

                  <div className="flex gap-2 mb-3">
                    <button
                      onClick={() => adjustNote('down')}
                      className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                    >
                      ‚Üì
                    </button>
                    <button
                      onClick={() => adjustNote('up')}
                      className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                    >
                      ‚Üë
                    </button>
                  </div>

                  <div className="flex gap-2 mb-3">
                    <button
                      onClick={isDronePlaying ? stopDrone : startDrone}
                      className={`flex-1 py-2 rounded-lg text-sm text-white ${
                        isDronePlaying ? 'bg-red-500' : 'bg-green-500'
                      }`}
                    >
                      {isDronePlaying ? 'Mute Drone' : 'Play Drone'}
                    </button>
                  </div>

                  {/* Recording controls */}
                  <div className="space-y-2">
                    <button
                      onClick={isRecording ? stopRecording : startRecording}
                      disabled={!micActive}
                      className={`w-full py-2 rounded-lg text-sm text-white font-semibold flex items-center justify-center gap-2 ${
                        !micActive ? 'bg-gray-300 cursor-not-allowed' :
                        isRecording ? 'bg-red-600' : 'bg-purple-600'
                      }`}
                      title={!micActive ? 'Activate microphone first' : ''}
                    >
                      {isRecording && <span className="inline-block w-3 h-3 bg-white rounded-full animate-pulse"></span>}
                      {isRecording ? 'Stop Recording' : 'Record'}
                    </button>

                    {lastRecording && (
                      <button
                        onClick={() => {
                          const audio = new Audio(lastRecording.url);
                          audio.play();
                        }}
                        className="w-full py-2 rounded-lg text-sm text-white font-semibold bg-pink-500"
                      >
                        Replay Last
                      </button>
                    )}

                    {recordings.length > 0 && (
                      <button
                        onClick={() => setShowRecordingsModal(true)}
                        className="w-full py-2 rounded-lg text-sm text-white font-semibold bg-orange-500"
                      >
                        Recordings ({recordings.length})
                      </button>
                    )}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Recordings Modal */}
          {showRecordingsModal && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
              onClick={() => setShowRecordingsModal(false)}
            >
              <div
                className="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden"
                onClick={(e) => e.stopPropagation()}
              >
                {/* Modal Header */}
                <div className="p-4 border-b border-gray-200 flex items-center justify-between" style={{backgroundColor: 'var(--brand-purple)'}}>
                  <h2 className="text-xl font-bold text-white">Your Recordings</h2>
                  <button
                    onClick={() => setShowRecordingsModal(false)}
                    className="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                  >
                    √ó
                  </button>
                </div>

                {/* Warning Message */}
                <div className="p-4 bg-yellow-50 border-b border-yellow-200">
                  <p className="text-sm text-yellow-800">
                    Note: Recordings are stored temporarily in your browser. They will be lost when you close this tab or refresh the page.
                  </p>
                </div>

                {/* Recordings List */}
                <div className="p-4 overflow-y-auto max-h-[calc(80vh-200px)]">
                  {recordings.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <div className="text-4xl mb-2"></div>
                      <p>No recordings yet</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {recordings.slice().reverse().map((recording, index) => (
                        <div
                          key={recording.id}
                          className="border-2 rounded-lg p-4 hover:shadow-md transition-shadow"
                          style={{borderColor: 'var(--brand-pink)'}}
                        >
                          <div className="flex items-start justify-between mb-3">
                            <div>
                              <div className="font-semibold" style={{color: 'var(--brand-grey)'}}>
                                Recording #{recordings.length - index}
                              </div>
                              <div className="text-xs text-gray-500">{recording.timestamp}</div>
                            </div>
                          </div>

                          {/* Audio Player */}
                          <audio
                            controls
                            src={recording.url}
                            className="w-full mb-3"
                            style={{height: '40px'}}
                          />

                          {/* Action Buttons */}
                          <div className="flex gap-2">
                            <button
                              onClick={() => downloadRecording(recording)}
                              className="flex-1 py-2 px-3 rounded-lg text-sm font-semibold text-white"
                              style={{backgroundColor: 'var(--brand-purple)'}}
                            >
                              Download
                            </button>
                            <button
                              onClick={() => {
                                if (window.confirm('Delete this recording?')) {
                                  deleteRecording(recording.id);
                                }
                              }}
                              className="py-2 px-3 rounded-lg text-sm font-semibold text-white bg-red-500"
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Modal Footer */}
                <div className="p-4 border-t border-gray-200 bg-gray-50">
                  <button
                    onClick={() => setShowRecordingsModal(false)}
                    className="w-full py-2 rounded-lg text-sm font-semibold text-white"
                    style={{backgroundColor: 'var(--brand-grey)'}}
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Pitch Control Settings Modal */}
          {showSettingsModal && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
              onClick={() => setShowSettingsModal(false)}
            >
              <div
                className="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-auto"
                onClick={(e) => e.stopPropagation()}
              >
                {/* Modal Header */}
                <div className="p-4 border-b border-gray-200 flex items-center justify-between" style={{backgroundColor: 'var(--brand-blue)'}}>
                  <h2 className="text-xl font-bold text-white">üéµ Pitch Control Settings</h2>
                  <button
                    onClick={() => setShowSettingsModal(false)}
                    className="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                  >
                    √ó
                  </button>
                </div>

                {/* Modal Content */}
                <div className="p-6 space-y-4">
                  {/* Target Note */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Target Note
                    </label>
                    <select
                      value={selectedNote}
                      onChange={(e) => setSelectedNote(e.target.value)}
                      className="w-full p-3 text-base border-2 font-medium rounded-lg"
                      style={{borderColor: 'var(--brand-blue)', backgroundColor: 'var(--brand-beige)'}}
                    >
                      {Object.entries(notes).map(([note, freq]) => (
                        <option key={note} value={note}>
                          {note} ({Math.round(freq)} Hz)
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Timbre */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Timbre (tone color)
                    </label>
                    <select
                      value={timbre}
                      onChange={(e) => setTimbre(e.target.value)}
                      className="w-full p-3 text-base border-2 font-medium rounded-lg"
                      style={{borderColor: 'var(--brand-blue)', backgroundColor: 'var(--brand-beige)'}}
                    >
                      <option value="sine">Sine ‚Äî soft / pure</option>
                      <option value="triangle">Triangle ‚Äî warm</option>
                      <option value="sawtooth">Saw ‚Äî bright</option>
                      <option value="square">Square ‚Äî hollow</option>
                    </select>
                  </div>

                  {/* Volume slider */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Drone Volume: <span className="font-bold" style={{color: 'var(--brand-blue)'}}>{volumePct}%</span>
                    </label>
                    <input
                      type="range"
                      min="0"
                      max="200"
                      step="5"
                      value={volumePct}
                      onChange={(e) => setVolumePct(parseInt(e.target.value, 10))}
                      className="w-full"
                      aria-label="Drone volume percent"
                      style={{accentColor: 'var(--brand-blue)'}}
                    />
                    <p className="text-xs font-medium mt-1" style={{color: 'var(--brand-grey)', opacity: '0.7'}}>
                      100% = original loudness. 200% = twice the original (safe).
                    </p>
                  </div>

                  {/* Boost / Soften toggles */}
                  <div className="space-y-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={phoneBoost}
                        onChange={(e) => setPhoneBoost(e.target.checked)}
                        className="w-4 h-4"
                        style={{accentColor: 'var(--brand-blue)'}}
                      />
                      <span className="text-sm font-bold uppercase tracking-wide" style={{color: 'var(--brand-grey)'}}>
                        Phone Boost (EQ + compressor)
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={softenHighs}
                        onChange={(e) => setSoftenHighs(e.target.checked)}
                        className="w-4 h-4"
                        style={{accentColor: 'var(--brand-blue)'}}
                      />
                      <span className="text-sm font-bold uppercase tracking-wide" style={{color: 'var(--brand-grey)'}}>
                        Soften highs (less metallic)
                      </span>
                    </label>
                  </div>
                </div>

                {/* Modal Footer */}
                <div className="p-4 border-t border-gray-200 bg-gray-50">
                  <button
                    onClick={() => setShowSettingsModal(false)}
                    className="w-full py-2 rounded-lg text-sm font-semibold text-white"
                    style={{backgroundColor: 'var(--brand-blue)'}}
                  >
                    Done
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<VoiceTrainingReader />);
  </script>
</body>
</html>
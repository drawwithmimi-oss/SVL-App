<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#904dff" />
  <title>Voice Training Companion - Transmasc Edition</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="../manifest.json" />

  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="../assets/Visuals/icones/Logo/logosquare.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Voice Trainer" />

  <!-- React / Babel / Tailwind -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- WebAudioRecorder.js Library -->
  <script src="../js/WebAudioRecorder.min.js"></script>

  <!-- Voice Audio Core - Shared audio engine (v2.6) -->
  <script src="../js/voice-audio-core.js"></script>

  <!-- Averia Serif Libre Font -->
  <link href="https://fonts.googleapis.com/css2?family=Averia+Serif+Libre:wght@700&display=swap" rel="stylesheet">

  <style>
    /* Custom CSS Variables for Brand Colors */
    :root {
      --brand-purple: #904dff;
      --brand-orange: #ff722f;
      --brand-pink: #ffa2fe;
      --brand-yellow: #fdd55a;
      --brand-beige: #fff4f2;
      --brand-grey: #3b1e36;
      --brand-blue: #6f81ff;
    }

    /* Dyslexia-friendly spacing; keep the simple, readable sans font you chose */
    .reading-text {
      font-family: Arial, Helvetica, sans-serif;
      line-height: 2;
      letter-spacing: 0.05em;
      word-spacing: 0.2em;
    }

    html { scroll-behavior: smooth; }

    /* Touch targets */
    button { min-height: 44px; min-width: 44px; }

    /* Cards with rounded corners */
    .training-card {
      transition: all 0.3s ease;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(59, 30, 54, 0.1);
    }

    .training-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(59, 30, 54, 0.15);
    }

    /* Floating bubble */
    .floating-bubble {
      position: fixed;
      right: 20px;
      bottom: 80px;
      z-index: 1000;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    .pitch-indicator { transition: all 0.3s ease; }

    /* Prevent accidental selection */
    button {
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Typography */
    .brand-heading {
      font-weight: 700;
      color: var(--brand-grey);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* iOS safe areas */
    .safe-top { padding-top: env(safe-area-inset-top); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    function VoiceTrainingReader() {
      // UI-only state (not audio-related)
      const [showBubble, setShowBubble] = useState(true); // Auto-show monitor
      const [bubbleExpanded, setBubbleExpanded] = useState(false);
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [selectedReading, setSelectedReading] = useState(null);
      const [fontSize, setFontSize] = useState('large');
      const [showRecordingsModal, setShowRecordingsModal] = useState(false);

      // Use shared audio engine (v2.6)
      const audio = useVoiceAudio(showRecordingsModal);

      // Destructure audio API for convenience
      const {
        isDronePlaying,
        selectedNote,
        currentPitch,
        micPermission,
        audioInitialized,
        micActive,
        isRecording,
        recordings,
        lastRecording,
        volumePct,
        timbre,
        softenHighs,
        phoneBoost,
        setVolumePct,
        setTimbre,
        setSoftenHighs,
        setPhoneBoost,
        setSelectedNote,
        activateMicrophone,
        togglePitchMonitor,
        stopMicrophoneForPlayback,
        restartMicrophoneAfterPlayback,
        startDrone,
        stopDrone,
        adjustNote,
        startRecording,
        stopRecording,
        deleteRecording,
        downloadRecording,
        audioRefs,
        notes,
        baseGain
      } = audio;

      /* Check URL params on load to auto-select reading or section */
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);

        // Check for specific reading selection
        const readingId = params.get('reading');
        if (readingId) {
          const reading = readings.find(r => r.id === readingId);
          if (reading) {
            setSelectedReading(reading);
            return;
          }
        }

        // Check for section selection (exercises)
        if (params.get('section') === 'exercises') {
          const exercisesReading = readings.find(r => r.id === 'exercises-link');
          if (exercisesReading) {
            setSelectedReading(exercisesReading);
          }
        }
      }, []);

      /* Transmasc Voice Training Readings */
      const readings = [
        {
          id: 'rainbow',
          title: 'Rainbow Passage',
          description: 'Classic voice training text',
          image: '../assets/Visuals/icones/Transfemme/Prism - rainbow passage.png',
          content: `When the sunlight strikes raindrops in the air, they act as a prism and form a rainbow. The rainbow is a division of white light into many beautiful colors. These take the shape of a long round arch, with its path high above, and its two ends apparently beyond the horizon. There is, according to legend, a boiling pot of gold at one end. People look, but no one ever finds it. When a person looks for something beyond their reach, their friends say they are looking for the pot of gold at the end of the rainbow.

Throughout the centuries people have explained the rainbow in various ways. Some have accepted it as a miracle without physical explanation. Others have tried to explain the phenomenon physically. Aristotle thought that the rainbow was caused by reflection of the sun's rays by the rain. Since then physicists have found that it is not reflection, but refraction by the raindrops which causes the rainbows.

Many complicated ideas about the rainbow have been formed. The difference in the rainbow depends considerably upon the size of the drops, and the width of the colored band increases as the size of the drops increases. The actual primary rainbow observed is said to be the effect of superimposition of a number of bows. If the red of the second bow falls upon the green of the first, the result is a bow with an abnormally wide yellow band, since red and green light when mixed form yellow. This is a very common type of bow, one showing mainly red and yellow, with little or no green or blue.`
        },
        {
          id: 'grandfather',
          title: 'Grandfather Passage',
          description: 'Standard practice text',
          image: '../assets/Visuals/icones/Transmasc/Grandfather Passage.png',
          content: `You wish to know all about my grandfather. Well, he is nearly 93 years old, yet he still thinks as swiftly as ever. He usually dresses himself in an old black frock coat with several buttons missing. A long beard clings to his chin, giving those who observe him a pronounced feeling of the utmost respect. When he speaks, his voice is just a bit cracked and quivers. Twice each day he plays skillfully and with zest upon a small organ. Except in the winter when the snow or ice prevents it, he slowly takes short walks in the open air. We have often urged him to walk more and smoke less, but he always answers, "Banana oil!" Grandfather likes to be modern in his language.`
        },
        {
          id: 'syllable-beanstalk',
          title: '"The Beanstalk" by Tara Meddaugh',
          description: 'Syllable Separation',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `See, I didn't...really...think that I'd make it this far up. Although, I've always been a bit of a climber. When I was nine months old, my mom found me sitting on top of the brown cow in the barn one morning. I never considered myself afraid of heights before, but it's not really the climbing up that scares me. It's the getting down, Black Crow...It seemed so easy getting here—just put one foot on the branch then another and...Oh, I've tried going down already. I put my foot on a branch, but it's slippery now. See? It's like the sludge at the bottom of the pig trough. And you do not want to be climbing down from the clouds on pig sludge! I'd fly off and land down there in a broken bone pile. And then everyone would just say, "Well, that's Jack. He doesn't know how to climb down, poor boy." And I guess they'd be right.`
        },
        {
          id: 'syllable-theo',
          title: '"What Theo Did" by Debra Neff',
          description: 'Syllable Separation',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `So Theo comes over and he's all like "Hey, Nickey, hey, Mel, what's up?" And I mean that was pretty nasty of him 'cause his girlfriend was like there, too, and he just kind of, you know, ignored her, ya know. So that was pretty nasty of him. But Jenny said she didn't care. Anyway, we go, "Not much, we're just kinda hangin' out, ya know." So Theo goes, "Well, I heard of a pretty good party across town. You wanna like crash?" And we thought that sounded pretty, ya know, killer. So there we were hangin' out at this party when we see this guy and Jenny goes, "Yo, that's Steven. I slept with him once." Well, I don't know if she did or not. I think she just wanted to get Theo mad 'cause he was like ignoring her, ya know. So she goes, "Yo, Steven." And Steven comes over and he's all, "Yo, Jen, what's up?" And that just about killed Theo 'cause he told us about this party and there's his girl talkin' to another guy. So Theo goes to me, "Yo, this is like pissing me off." And I go, "Yo, well, Theo, you're ignoring her and it's nasty." So he goes, "Yo, you're right." And he goes over and starts talkin' to Jen. So they're like talkin', right? And then they start to like argue, and the argument got louder and louder. But I wasn't listening or anything.`
        },
        {
          id: 'tempo-pygmalion',
          title: 'Pygmalion by George Bernard Shaw',
          description: 'Tempo',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `Don't say that, Governor. Don't look at it that way. What am I, Governors both? I ask you, what am I? I'm one of the undeserving poor: that's what I am. Think of what that means to a man. It means that he's up agen middle class morality all the time. If there's anything going, and I put in for a bit of it, it's always the same story: "You're undeserving; so you can't have it." But my needs is as great as the most deserving widow's that ever got money out of six different charities in one week for the death of the same husband. I don't need less than a deserving man: I need more. I don't eat less hearty than him; and I drink a lot more. I want a bit of amusement, cause I'm a thinking man. I want cheerfulness and a song and a band when I feel low. Well, they charge me just the same for everything as they charge the deserving. What is middle class morality? Just an excuse for never giving me anything. Therefore, I ask you, as two gentlemen, not to play that game on me. I'm playing straight with you. I ain't pretending to be deserving. I'm undeserving; and I mean to go on being undeserving. I like it; and that's the truth.`
        },
        {
          id: 'tempo-play-wrong',
          title: '"The Play That Goes Wrong"',
          description: 'Tempo',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `Good evening, ladies...and gentlemen, and welcome to the Cornley Polytechnic Society's spring production of The Murder at Haversham Manor. I would like to personally welcome you to what will be my directorial debut, and my first production as head of the drama society. We are particularly excited to present this play because, for the first time in the society's history, we have managed to find a play that fits the company's numbers perfectly. If we're honest, a lack of numbers has hampered past productions, such as last year's Chekov play, Two Sisters, or last Christmas's The Lion and the Wardrobe, and of course our summer musical, Cat. This will be the first time the society has been able to stage a play of this scale and we are thrilled. It's no secret we usually have to contend with a small budget, as we had to in last year's presentation of Roald Dahl's classic, James and the Peach. Of course, during the run of that particular show the peach went off and we were forced to present a hastily devised alternative entitled James! Where's Your Peach? Finally, we've managed to stage a play as it should be, and cast it exceptionally well. I'm sure no one will forget the problems we've faced with casting before, such as 2010's Christmas presentation of Snow White and the Tall, Broad Gentlemen, or indeed our previous year's pantomime, another Disney classic: Ugly...and the Beast. But now, on with the main event, which I am confident will be our best show yet! So without any further ado, please put your hands together for Susie H.K. Brideswell's thrilling whodunit – The Murder at Haversham Manor.`
        },
        {
          id: 'articulation-schroeder',
          title: 'Schroeder from "Charlie Brown"',
          description: 'Articulation',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `I'm sorry to have to say it to your face, Lucy, but it's true. You're a very crabby person. I know your crabbiness has probably become so natural to you now that you're not even aware when you're being crabby, but it's true just the same. You're a very crabby person and you're crabby to just about everyone you meet. Now I hope you don't mind my saying this, Lucy, and I hope you'll take it in the spirit that it's meant. I think we should be very open to any opportunity to learn more about ourselves. I think Socrates was very right when he said that one of the first rules for anyone in life is 'Know Thyself'. Well, I guess I've said about enough. I hope I haven't offended you or anything.`
        },
        {
          id: 'articulation-there-he-is',
          title: '"There He Is" by Joseph Arnone',
          description: 'Articulation',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `My co-worker is the most annoying guy in the world. I wish to God I wasn't so nice to him when I first started working at my new job. I should have wondered why he was so overly nice at the start. I thought it was just good manners but it was purely desperation. You see, the guy is a douchebag, alright? There, I said it. All the other co-workers round on him like he's diseased and now I'm stuck with him and don't know how to get rid of him. I don't mean to sound mean and I know I probably do but you don't understand. For example, every morning when I get to the office, I go into the break room for my morning cup of coffee, this is my moment, the moment I take before dealing with my loser of a manager and all the other dipsh'ts I have to smile at and report to. It's this one little coffee moment, by myself, in the quiet of my tortured life, that I work up all the strength and courage I need to walk down that pathetic hallway, to my desk. But noooo, I have fantastic Andrew popping in now because he knows, he knows I'm all alone, so he jumps at the opportunity to speak to me with his cheese and fart breath, about whatever it is he did the night before, which is absolutely nothing all that interesting, whatsoever. (imitates Andrew) "I leveled up in my game man, I leveled up!" Who-gives-a-fly-ing-sh't-man?`
        },
        {
          id: 'spotted-man',
          title: 'The Spotted Man by Walter Wykes',
          description: 'Articulation',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `What am I trying to HIDE?! What am I ... I'm not trying to HIDE anything! Look at me! Look! My entire body is covered with spots! Spots of every conceivable shape and size! Big spots! Small spots! Short spots! Tall spots! I have a spot the shape of Italy on my back! And another one ... I ... I know it sounds crazy, but ... I'd swear it's the virgin Mary! On my ... ahh ... on my ... I'm not comfortable talking about this with you! I'd like to see the doctor! I'm a very sick man! There is something horribly, horribly wrong with me, and I've come to you for help! Can't you just help me?! Isn't that why you're here?! To help people who are sick?! What ... ahh ... what are you writing? You know, I ... I can't help but feel we've gotten off on the wrong foot somehow. I'd like to apologize if I've offended you in any way or ... or made your job more difficult. That was certainly not my intent. It's just that I ... I'm very concerned about these spots! I'm not normally like this. Normally, I'm very relaxed. Very laid back. Really! Water off the back—all that! You can ask my wife, she'll tell you. But these spots ... they ... they've gotten under my skin! It's almost ... I know this may sound a little crazy ... but it's almost like they're alive!`
        },
        {
          id: 'leprechaun',
          title: 'Honey, I\'m a Leprechaun from Goodbye Charles by Gabriel Davis',
          description: 'Vowels',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `Why can't you accept I'm a leprechaun? It's like you're embarrassed. When we're out and I mention to people that I've recently transformed into a leprechaun, you always laugh lightly then veer the conversation to another topic. I don't want them to think I'm crazy either, but I can't lie about who I am. It is who I am. Look at the facts. There's a salary freeze but I got a raise. The market took a beating, but my stocks are up. Housing values are in the toilet, just not our house. No people aren't lucky like that. How do you explain that rainbow in our backyard? Rainbows do not linger for a week in low humidity. I mean I get this isn't what you bargained for when you said "I do" But people change. Not usually into leprechauns but - and granted the priest said "do you take this man..." not "do you take this leprechaun..." But this can't come as a total surprise. When you went on that special K diet and I went on that lucky charms diet...that should have tipped you off...Or when I started to develop five o'clock shadows at 10 am. Honey, this kind of aggressive beard growth is not natural...for humans. And I get you don't like it, how the stubble chafes, and that's why I'm shaving every hour practically, for you.`
        },
        {
          id: 'barry-dreams',
          title: 'Barry from \'Dreams in Captivity\'',
          description: 'Stressing by volume, pitch, and consonants',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `You know why men are constantly fighting instead of working together to survive? Simple. Man is mainly motivated to sit on his ass. Our greatest inventors are busy right now finding more ways for us to sit on our ass better. And when they make it, men will kill to sit on it. Wars will happen because every man wants the best Lazy Boy Recliner in the galaxy. AND I SELL IT. I sell a deluxe Lazy Boy outfitted with massagers, heating pads, a cooling unit for drinks – it's the closest experience of comfort a man can get on earth short of climbing back through his mother's hoo-ha into the womb. If it's a choice between that and helping you colonize space? No contest.`
        },
        {
          id: 'gilded-age',
          title: '\'The Gilded Age\' by Mark Twain',
          description: 'Stressing by volume, pitch, and consonants',
          image: '../assets/Visuals/icones/Transmasc/Masc Monologues.pdf.png',
          content: `Wait, Nancy, wait--let me finish--I've been secretly bailing and fuming with this grand inspiration for weeks, and I must talk or I'll burst! I haven't whispered to a soul--not a word--have had my countenance under lock and key, for fear it might drop something that would tell even these animals here how to discern the gold mine that's glaring under their noses. Now all that is necessary to hold this land and keep it in the family is to pay the trifling taxes on it yearly--five or ten dollars--the whole tract would not sell for over a third of a cent an acre now, but some day people wild be glad to get it for twenty dollars, fifty dollars, a hundred dollars an acre! What should you say to --a thousand dollars an acre!`
        },
        {
          id: 'exercises-link',
          title: '📋 Exercise Resources',
          description: 'Additional practice materials and guides',
          content: 'RESOURCES',
          isResourceList: true,
          resources: [
            { title: 'Vowel Placement', pdfUrl: 'https://drive.google.com/file/d/1O77UEz7p8dH3KtmUwSMgqWj7B34_3bkT/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Rainbow Passage', pdfUrl: 'https://drive.google.com/file/d/1F0GKKgbnQE7_GnUAXoBt3EIzH8kkpZho/view?usp=drive_link', digitalPage: './index.html?reading=rainbow', status: 'available' },
            { title: 'Masc Monologues', pdfUrl: 'https://drive.google.com/file/d/11ZEbK-BE0OVag_t7HajVZ-9u7tTw74Zi/view?usp=drive_link', digitalPage: './index.html', status: 'available' },
            { title: 'Masculine Vowel Chart', pdfUrl: 'https://drive.google.com/file/d/10YC1-trnQ6ss3ApMPH5GVEVH0HbTxRP7/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Masc Vowel Glides', pdfUrl: 'https://drive.google.com/file/d/1wz1z8jr422-0enQEvtTf7un-wXHW4bVv/view?usp=drive_link', status: 'coming-soon' },
            { title: 'FTM Students Syllabus', pdfUrl: 'https://drive.google.com/file/d/1H3jjhw2NqYs-ekJNn383RUExNBZJ2byv/view?usp=drive_link', status: 'coming-soon' },
            { title: 'Grandfather Passage', pdfUrl: 'https://drive.google.com/file/d/17FkG9Wf3Be1txC8nRa7JIK25FN3whnjS/view?usp=drive_link', digitalPage: './index.html?reading=grandfather', status: 'available' },
            { title: 'Consonant Buddies', pdfUrl: 'https://drive.google.com/file/d/13qUGZyE_07MByOMjc3ffqpd41BbAlRCA/view?usp=drive_link', status: 'coming-soon' }
          ]
        }
      ];

      // UI helper functions
      const handleTogglePitchMonitor = useCallback(async () => {
        await togglePitchMonitor();
        setShowBubble(true);
      }, [togglePitchMonitor]);

      const getPitchColor = () => {
        if (currentPitch === 0) return 'bg-gray-400';
        const target = notes[selectedNote];
        const diff = Math.abs(currentPitch - target);
        if (diff < 5) return 'bg-green-500';
        if (diff < 15) return 'bg-yellow-500';
        return 'bg-red-500';
      };

      const getPitchStatus = () => {
        if (currentPitch === 0) return '---';
        const target = notes[selectedNote];
        const diff = currentPitch - target;
        if (Math.abs(diff) < 5) return `${currentPitch}`;
        if (diff > 0) return `${currentPitch}↓`;
        return `${currentPitch}↑`;
      };

      const getFontSizeClass = () => {
        switch (fontSize) {
          case 'small': return 'text-base';
          case 'large': return 'text-xl';
          case 'xlarge': return 'text-2xl';
          default: return 'text-lg';
        }
      };

      return (
        <div className="min-h-screen safe-top safe-bottom" style={{backgroundColor: 'var(--brand-beige)'}}>
          {/* Header */}
          <header className="safe-top" style={{backgroundColor: 'var(--brand-purple)', color: 'white', boxShadow: '0 4px 20px rgba(144, 77, 255, 0.3)'}}>
            <div className="px-6 py-4">
              <div className="flex flex-col items-center gap-4">
                <h1 className="text-3xl font-bold uppercase tracking-wide text-white drop-shadow-md text-center" style={{fontFamily: "'Averia Serif Libre', serif"}}>💜 Transmasc Voice Training</h1>
                <div className="flex gap-3">
                  <button
                    onClick={() => window.location.href = '../'}
                    className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                    onMouseOver={(e) => {
                      e.target.style.backgroundColor = 'white';
                      e.target.style.color = 'var(--brand-pink)';
                    }}
                    onMouseOut={(e) => {
                      e.target.style.backgroundColor = 'transparent';
                      e.target.style.color = 'white';
                    }}
                  >
                    ← Back to Main
                  </button>
                  {selectedReading && selectedReading.id === 'exercises-link' && (
                    <button
                      onClick={() => setSelectedReading(null)}
                      className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                      onMouseOver={(e) => {
                        e.target.style.backgroundColor = 'white';
                        e.target.style.color = 'var(--brand-pink)';
                      }}
                      onMouseOut={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                        e.target.style.color = 'white';
                      }}
                    >
                      → Switch to Reading
                    </button>
                  )}
                  {!selectedReading && (
                    <button
                      onClick={() => {
                        const exercises = readings.find(r => r.id === 'exercises-link');
                        if (exercises) setSelectedReading(exercises);
                      }}
                      className="transition-all duration-300 font-bold uppercase tracking-wide text-sm px-4 py-2 rounded-full border-2 border-white text-white hover:bg-white"
                      onMouseOver={(e) => {
                        e.target.style.backgroundColor = 'white';
                        e.target.style.color = 'var(--brand-pink)';
                      }}
                      onMouseOut={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                        e.target.style.color = 'white';
                      }}
                    >
                      → Switch to Exercises
                    </button>
                  )}
                </div>
              </div>
            </div>
          </header>

          {/* Main */}
          <div className="p-6 pb-20" style={{minHeight: 'calc(100vh - 100px)'}}>
            {/* Mic permission helper */}
            {micPermission === 'denied' && (
              <div className="mb-4 p-4 bg-red-100 border border-red-300 rounded-lg">
                <p className="text-red-800">🎤 Microphone access required for pitch detection</p>
                <button
                  onClick={initAudio}
                  className="mt-2 px-4 py-2 bg-red-500 text-white rounded-lg"
                >
                  Grant Access
                </button>
              </div>
            )}

            {!selectedReading ? (
              <>
                {/* Reading selection */}
                <div className="bg-white training-card p-8">
                  <h2 className="text-2xl brand-heading mb-6" style={{color: 'var(--brand-grey)'}}>📚 Select Reading Material</h2>
                  <div className="space-y-3">
                    {readings.filter(r => r.id !== 'exercises-link').map((reading) => (
                      <button
                        key={reading.id}
                        onClick={() => setSelectedReading(reading)}
                        className="w-full text-left p-6 border-2 transition-all duration-300 transform hover:-translate-y-1"
                        style={{
                          borderColor: 'var(--brand-pink)',
                          borderRadius: '15px',
                          backgroundColor: 'var(--brand-beige)'
                        }}
                        onMouseOver={(e) => {
                          e.target.style.backgroundColor = 'white';
                          e.target.style.boxShadow = '0 8px 25px rgba(255, 162, 254, 0.2)';
                        }}
                        onMouseOut={(e) => {
                          e.target.style.backgroundColor = 'var(--brand-beige)';
                          e.target.style.boxShadow = 'none';
                        }}
                      >
                        <div className="font-bold text-lg mb-2" style={{color: 'var(--brand-grey)'}}>{reading.title}</div>
                        <div className="text-sm font-medium" style={{color: 'var(--brand-grey)', opacity: '0.8'}}>{reading.description}</div>
                      </button>
                    ))}
                  </div>
                </div>
              </>
            ) : (
              /* Reading view */
              <div className="bg-white training-card p-8">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <button
                      onClick={() => setSelectedReading(null)}
                      className="font-bold uppercase tracking-wide text-sm mb-4 transition-colors"
                      style={{color: 'var(--brand-pink)'}}
                      onMouseOver={(e) => e.target.style.color = 'var(--brand-purple)'}
                      onMouseOut={(e) => e.target.style.color = 'var(--brand-pink)'}
                    >
                      ← Back to Materials
                    </button>
                  </div>
                  {!selectedReading.isResourceList && (
                    <div className="flex gap-2">
                      <button
                        onClick={() => {
                          const sizes = ['small', 'medium', 'large', 'xlarge'];
                          const current = sizes.indexOf(fontSize);
                          setFontSize(sizes[(current + 1) % sizes.length]);
                        }}
                        className="px-4 py-2 text-sm font-bold uppercase tracking-wide transition-all duration-300 transform hover:-translate-y-1"
                        style={{
                          borderRadius: '10px',
                          background: 'linear-gradient(135deg, var(--brand-yellow), var(--brand-orange))',
                          color: 'white',
                          boxShadow: '0 4px 15px rgba(253, 213, 90, 0.3)'
                        }}
                      >
                        Aa Size
                      </button>
                    </div>
                  )}
                </div>

                {/* Image if present */}
                {selectedReading.image && (
                  <div className="text-center mb-6">
                    <img
                      src={selectedReading.image}
                      alt={selectedReading.title}
                      style={{
                        maxWidth: '300px',
                        width: '100%',
                        height: 'auto',
                        margin: '0 auto',
                        display: 'block'
                      }}
                    />
                  </div>
                )}

                {/* Title and description centered */}
                <div className="text-center mb-6">
                  <h2 className="text-2xl brand-heading mb-2">{selectedReading.title}</h2>
                  <p className="text-lg font-medium" style={{color: 'var(--brand-grey)', opacity: '0.8'}}>{selectedReading.description}</p>
                </div>

                {selectedReading.isResourceList ? (
                  <div className="space-y-4">
                    {selectedReading.resources.map((resource, index) => (
                      <div
                        key={index}
                        className="p-5 border-2 transition-all duration-300"
                        style={{
                          borderColor: 'var(--brand-pink)',
                          borderRadius: '15px',
                          backgroundColor: 'var(--brand-beige)',
                          boxShadow: '0 2px 10px rgba(255, 162, 254, 0.1)'
                        }}
                      >
                        <div className="mb-3">
                          <div className="font-bold text-lg" style={{color: 'var(--brand-grey)'}}>{resource.title}</div>
                        </div>

                        {resource.isVideo ? (
                          // Single button for video exercises
                          <a
                            href={resource.digitalPage}
                            className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                            style={{
                              backgroundColor: 'var(--brand-purple)',
                              color: 'white',
                              textDecoration: 'none',
                              boxShadow: '0 4px 15px rgba(144, 77, 255, 0.3)'
                            }}
                          >
                            🎬 Watch Video
                          </a>
                        ) : (
                          // Two-button layout for regular exercises
                          <div className="grid grid-cols-2 gap-3">
                            {/* PDF Button */}
                            <a
                              href={resource.pdfUrl}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                              style={{
                                backgroundColor: 'var(--brand-purple)',
                                color: 'white',
                                textDecoration: 'none',
                                boxShadow: '0 4px 15px rgba(144, 77, 255, 0.3)'
                              }}
                            >
                              📄 PDF Printable
                            </a>

                            {/* Digital View Button */}
                            {resource.status === 'available' ? (
                              <a
                                href={resource.digitalPage}
                                className="block text-center py-3 px-4 rounded-lg font-bold text-sm transition-all duration-300 hover:-translate-y-1"
                                style={{
                                  backgroundColor: 'var(--brand-pink)',
                                  color: 'var(--brand-grey)',
                                  textDecoration: 'none',
                                  boxShadow: '0 4px 15px rgba(255, 162, 254, 0.3)'
                                }}
                              >
                                📱 View in App
                              </a>
                            ) : (
                              <div
                                className="text-center py-3 px-4 rounded-lg font-bold text-sm cursor-not-allowed"
                                style={{
                                  backgroundColor: '#e5e7eb',
                                  color: '#9ca3af'
                                }}
                              >
                                📱 Coming Soon
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className={`reading-text ${getFontSizeClass()} whitespace-pre-wrap`} style={{color: 'var(--brand-grey)'}}>
                    {selectedReading.content}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Floating pitch bubble */}
          {showBubble && (
            <div className="floating-bubble">
              {!bubbleExpanded ? (
                <button
                  onClick={() => {
                    if (!micActive) {
                      activateMicrophone();
                    }
                    setBubbleExpanded(true);
                  }}
                  className={`relative w-20 h-16 rounded-full shadow-lg flex flex-col items-center justify-center text-white font-bold text-sm pitch-indicator ${micActive ? getPitchColor() : 'bg-gray-400'}`}
                  style={{
                    animation: 'pulse 2s infinite',
                    cursor: 'pointer',
                    border: '2px solid rgba(255,255,255,0.5)'
                  }}
                  title={micActive ? "Click to expand controls" : "Click to activate microphone"}
                >
                  <div style={{fontSize: '18px', marginTop: '-4px'}}>
                    {micActive ? getPitchStatus() : '🔇'}
                  </div>
                  <div style={{fontSize: '10px', marginTop: '2px', opacity: 0.9}}>
                    {micActive ? '⬆️' : 'TAP'}
                  </div>
                </button>
              ) : (
                <div className="bg-white rounded-2xl shadow-xl p-4 w-48">
                  <div className="flex justify-between items-center mb-3">
                    <span className="font-semibold text-sm">Pitch Monitor</span>
                    <div className="flex gap-2">
                      <button
                        onClick={() => setShowSettingsModal(true)}
                        className="text-gray-600 hover:text-purple-600 text-lg"
                        title="Pitch Control Settings"
                      >
                        ⚙️
                      </button>
                      <button
                        onClick={() => setBubbleExpanded(false)}
                        className="text-gray-500 text-xl"
                      >
                        ×
                      </button>
                    </div>
                  </div>

                  <div className="text-center mb-3">
                    <div className={`text-2xl font-bold ${
                      currentPitch === 0
                        ? 'text-gray-400'
                        : Math.abs(currentPitch - notes[selectedNote]) < 5
                        ? 'text-green-500'
                        : Math.abs(currentPitch - notes[selectedNote]) < 15
                        ? 'text-yellow-500'
                        : 'text-red-500'
                    }`}>
                      {currentPitch > 0 ? `${currentPitch} Hz` : '---'}
                    </div>
                    <div className="text-xs text-gray-500">
                      Target: {selectedNote} ({Math.round(notes[selectedNote])} Hz)
                    </div>
                  </div>

                  <div className="flex gap-2 mb-3">
                    <button
                      onClick={() => adjustNote('down')}
                      className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                    >
                      ↓
                    </button>
                    <button
                      onClick={() => adjustNote('up')}
                      className="flex-1 py-2 bg-blue-500 text-white rounded-lg text-sm"
                    >
                      ↑
                    </button>
                  </div>

                  <div className="flex gap-2 mb-3">
                    <button
                      onClick={isDronePlaying ? stopDrone : startDrone}
                      className={`flex-1 py-2 rounded-lg text-sm text-white ${
                        isDronePlaying ? 'bg-red-500' : 'bg-green-500'
                      }`}
                    >
                      {isDronePlaying ? 'Mute Drone' : 'Play Drone'}
                    </button>
                  </div>

                  {/* Recording controls (WAV format only) */}
                  <div className="space-y-2">
                    <button
                      onClick={isRecording ? stopRecording : startRecording}
                      className={`w-full py-2 rounded-lg text-sm text-white font-semibold flex items-center justify-center gap-2 ${
                        isRecording ? 'bg-red-600' : 'bg-purple-600'
                      }`}
                    >
                      {isRecording && <span className="inline-block w-3 h-3 bg-white rounded-full animate-pulse"></span>}
                      {isRecording ? 'Stop Recording' : '🎙️ Record'}
                    </button>

                    {lastRecording && (
                      <button
                        onClick={async () => {
                          // Stop mic BEFORE starting playback (critical for iOS volume)
                          stopMicrophoneForPlayback();

                          // Wait for mic to fully release (Safari needs time to update audio route)
                          await new Promise(resolve => setTimeout(resolve, 200));

                          const audio = new Audio(lastRecording.url);
                          // Only restart on ended (not pause - that causes duplicate restarts)
                          audio.onended = restartMicrophoneAfterPlayback;
                          audio.play();
                        }}
                        className="w-full py-2 rounded-lg text-sm text-white font-semibold bg-pink-500"
                      >
                        ▶️ Replay Last
                      </button>
                    )}

                    {recordings.length > 0 && (
                      <button
                        onClick={() => setShowRecordingsModal(true)}
                        className="w-full py-2 rounded-lg text-sm text-white font-semibold bg-orange-500"
                      >
                        📋 Recordings ({recordings.length})
                      </button>
                    )}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Recordings Modal */}
          {showRecordingsModal && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
              onClick={() => setShowRecordingsModal(false)}
            >
              <div
                className="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden"
                onClick={(e) => e.stopPropagation()}
              >
                {/* Modal Header */}
                <div className="p-4 border-b border-gray-200 flex items-center justify-between" style={{backgroundColor: 'var(--brand-purple)'}}>
                  <h2 className="text-xl font-bold text-white">🎙️ Your Recordings</h2>
                  <button
                    onClick={() => setShowRecordingsModal(false)}
                    className="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                  >
                    ×
                  </button>
                </div>

                {/* Warning Message */}
                <div className="p-4 bg-yellow-50 border-b border-yellow-200">
                  <p className="text-sm text-yellow-800">
                    ⚠️ <strong>Note:</strong> Recordings are stored temporarily in your browser. They will be lost when you close this tab or refresh the page.
                  </p>
                </div>

                {/* Recordings List */}
                <div className="p-4 overflow-y-auto max-h-[calc(80vh-200px)]">
                  {recordings.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <div className="text-4xl mb-2">🎤</div>
                      <p>No recordings yet</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {recordings.slice().reverse().map((recording, index) => (
                        <div
                          key={recording.id}
                          className="border-2 rounded-lg p-4 hover:shadow-md transition-shadow"
                          style={{borderColor: 'var(--brand-pink)'}}
                        >
                          <div className="flex items-start justify-between mb-3">
                            <div>
                              <div className="font-semibold" style={{color: 'var(--brand-grey)'}}>
                                Recording #{recordings.length - index}
                              </div>
                              <div className="text-xs text-gray-500">{recording.timestamp}</div>
                            </div>
                          </div>

                          {/* Audio Player */}
                          <audio
                            ref={(el) => { if (el) audioRefs.current[recording.id] = el; }}
                            controls
                            playsinline
                            preload="auto"
                            src={recording.url}
                            className="w-full mb-3"
                            style={{height: '40px'}}
                          />

                          {/* Action Buttons */}
                          <div className="flex gap-2">
                            <button
                              onClick={() => downloadRecording(recording)}
                              className="flex-1 py-2 px-3 rounded-lg text-sm font-semibold text-white"
                              style={{backgroundColor: 'var(--brand-purple)'}}
                            >
                              ⬇️ Download
                            </button>
                            <button
                              onClick={() => {
                                if (window.confirm('Delete this recording?')) {
                                  deleteRecording(recording.id);
                                }
                              }}
                              className="py-2 px-3 rounded-lg text-sm font-semibold text-white bg-red-500"
                            >
                              🗑️ Delete
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Modal Footer */}
                <div className="p-4 border-t border-gray-200 bg-gray-50">
                  <button
                    onClick={() => setShowRecordingsModal(false)}
                    className="w-full py-2 rounded-lg text-sm font-semibold text-white"
                    style={{backgroundColor: 'var(--brand-grey)'}}
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Pitch Control Settings Modal */}
          {showSettingsModal && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
              onClick={() => setShowSettingsModal(false)}
            >
              <div
                className="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-auto"
                onClick={(e) => e.stopPropagation()}
              >
                {/* Modal Header */}
                <div className="p-4 border-b border-gray-200 flex items-center justify-between" style={{backgroundColor: 'var(--brand-pink)'}}>
                  <h2 className="text-xl font-bold text-white">🎵 Pitch Control Settings</h2>
                  <button
                    onClick={() => setShowSettingsModal(false)}
                    className="text-white text-2xl hover:bg-white hover:bg-opacity-20 rounded-full w-8 h-8 flex items-center justify-center"
                  >
                    ×
                  </button>
                </div>

                {/* Modal Content */}
                <div className="p-6 space-y-4">
                  {/* Target Note */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Target Note
                    </label>
                    <select
                      value={selectedNote}
                      onChange={(e) => setSelectedNote(e.target.value)}
                      className="w-full p-3 text-base border-2 font-medium rounded-lg"
                      style={{borderColor: 'var(--brand-pink)', backgroundColor: 'var(--brand-beige)'}}
                    >
                      {Object.entries(notes).map(([note, freq]) => (
                        <option key={note} value={note}>
                          {note} ({Math.round(freq)} Hz)
                        </option>
                      ))}
                    </select>
                  </div>

                  {/* Timbre */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Timbre (tone color)
                    </label>
                    <select
                      value={timbre}
                      onChange={(e) => setTimbre(e.target.value)}
                      className="w-full p-3 text-base border-2 font-medium rounded-lg"
                      style={{borderColor: 'var(--brand-pink)', backgroundColor: 'var(--brand-beige)'}}
                    >
                      <option value="sine">Sine — soft / pure</option>
                      <option value="triangle">Triangle — warm</option>
                      <option value="sawtooth">Saw — bright</option>
                      <option value="square">Square — hollow</option>
                    </select>
                  </div>

                  {/* Volume slider */}
                  <div>
                    <label className="block text-sm font-bold uppercase tracking-wide mb-2" style={{color: 'var(--brand-grey)'}}>
                      Drone Volume: <span className="font-bold" style={{color: 'var(--brand-pink)'}}>{volumePct}%</span>
                    </label>
                    <input
                      type="range"
                      min="0"
                      max="200"
                      step="5"
                      value={volumePct}
                      onChange={(e) => setVolumePct(parseInt(e.target.value, 10))}
                      className="w-full"
                      aria-label="Drone volume percent"
                      style={{accentColor: 'var(--brand-pink)'}}
                    />
                    <p className="text-xs font-medium mt-1" style={{color: 'var(--brand-grey)', opacity: '0.7'}}>
                      100% = original loudness. 200% = twice the original (safe).
                    </p>
                  </div>

                  {/* Boost / Soften toggles */}
                  <div className="space-y-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={phoneBoost}
                        onChange={(e) => setPhoneBoost(e.target.checked)}
                        className="w-4 h-4"
                        style={{accentColor: 'var(--brand-pink)'}}
                      />
                      <span className="text-sm font-bold uppercase tracking-wide" style={{color: 'var(--brand-grey)'}}>
                        Phone Boost (EQ + compressor)
                      </span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={softenHighs}
                        onChange={(e) => setSoftenHighs(e.target.checked)}
                        className="w-4 h-4"
                        style={{accentColor: 'var(--brand-pink)'}}
                      />
                      <span className="text-sm font-bold uppercase tracking-wide" style={{color: 'var(--brand-grey)'}}>
                        Soften highs (less metallic)
                      </span>
                    </label>
                  </div>
                </div>

                {/* Modal Footer */}
                <div className="p-4 border-t border-gray-200 bg-gray-50">
                  <button
                    onClick={() => setShowSettingsModal(false)}
                    className="w-full py-2 rounded-lg text-sm font-semibold text-white"
                    style={{backgroundColor: 'var(--brand-pink)'}}
                  >
                    Done
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<VoiceTrainingReader />);
  </script>
</body>
</html>